<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>Intel Pin 2 ：示例（再续） | Star</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="Pin," />
  

  <meta name="description" content="继续Intel Pin示例系列。">
<meta property="og:type" content="article">
<meta property="og:title" content="Intel Pin 2 ：示例（再续）">
<meta property="og:url" content="http://huirong.github.io/2016/01/10/Intel-Pin-Example4/index.html">
<meta property="og:site_name" content="Star">
<meta property="og:description" content="继续Intel Pin示例系列。">
<meta property="og:updated_time" content="2016-01-12T06:38:17.269Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Intel Pin 2 ：示例（再续）">
<meta name="twitter:description" content="继续Intel Pin示例系列。">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=028c63b1" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/huirong.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016sfsf1fba3xxxx8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Using-TLS"><span class="toc-text">Using TLS</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Using-the-Fast-Buffering-APIs"><span class="toc-text">Using the Fast Buffering APIs</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Finding-the-Static-Properties-of-an-Image-查看镜像的静态属性"><span class="toc-text">Finding the Static Properties of an Image 查看镜像的静态属性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Detaching-Pin-from-the-Application"><span class="toc-text">Detaching Pin from the Application</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Instrumenting-Child-Processes"><span class="toc-text">Instrumenting Child Processes</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Managed-platforms-support"><span class="toc-text">Managed platforms support</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考文献"><span class="toc-text">参考文献</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-Intel-Pin-Example4" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">Intel Pin 2 ：示例（再续）</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2016.01.10</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>star</span>
        </span>
      

      


      
        <span>
          <i class="icon-comment"></i>
          <a href="http://huirong.github.io/2016/01/10/Intel-Pin-Example4/#disqus_thread"></a>
        </span>
      

    </div>
  </header>

  <div class="article-content">
    
      <p>继续Intel Pin示例系列。<br><a id="more"></a></p>
<h1 id="Using-TLS"><a href="#Using-TLS" class="headerlink" title="Using TLS"></a>Using TLS</h1><p>Pin提供了高效的线程本地存储（ thread local storage (TLS) ）APIs，用于创建线程特定数据。<br>下例展示了如何使用这些APIs。<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ ../../../pin -t obj-ia32/inscount_tls.so -- obj-ia32/thread_lin</div><div class="line">$ head</div><div class="line">Count[<span class="number">0</span>]= <span class="number">237993</span></div><div class="line">Count[<span class="number">1</span>]= <span class="number">213296</span></div><div class="line">Count[<span class="number">2</span>]= <span class="number">209223</span></div><div class="line">Count[<span class="number">3</span>]= <span class="number">209223</span></div><div class="line">Count[<span class="number">4</span>]= <span class="number">209223</span></div><div class="line">Count[<span class="number">5</span>]= <span class="number">209223</span></div><div class="line">Count[<span class="number">6</span>]= <span class="number">209223</span></div><div class="line">Count[<span class="number">7</span>]= <span class="number">209223</span></div><div class="line">Count[<span class="number">8</span>]= <span class="number">209223</span></div><div class="line">Count[<span class="number">9</span>]= <span class="number">209223</span></div></pre></td></tr></table></figure></p>
<p>源码参见 source/tools/ManualExamples/inscount_tls.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></div><div class="line"></div><div class="line">KNOB&lt;<span class="built_in">string</span>&gt; KnobOutputFile(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>,</div><div class="line">    <span class="string">"o"</span>, <span class="string">"inscount_tls.out"</span>, <span class="string">"specify output file name"</span>);</div><div class="line"></div><div class="line">PIN_LOCK lock;</div><div class="line">INT32 numThreads = <span class="number">0</span>;</div><div class="line">ofstream OutFile;</div><div class="line"></div><div class="line"><span class="comment">// Force each thread's data to be in its own data cache line so that</span></div><div class="line"><span class="comment">// multiple threads do not contend for the same data cache line.</span></div><div class="line"><span class="comment">// This avoids the false sharing problem.</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> PADSIZE 56  <span class="comment">// 64 byte line size: 64-8</span></span></div><div class="line"></div><div class="line"><span class="comment">// a running count of the instructions</span></div><div class="line"><span class="keyword">class</span> <span class="keyword">thread_data_t</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    <span class="keyword">thread_data_t</span>() : <span class="number">_</span>count(<span class="number">0</span>) &#123;&#125;</div><div class="line">    UINT64 <span class="number">_</span>count;</div><div class="line">    UINT8 <span class="number">_</span>pad[PADSIZE];</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// key for accessing TLS storage in the threads. initialized once in main()</span></div><div class="line"><span class="keyword">static</span>  TLS_KEY tls_key;</div><div class="line"></div><div class="line"><span class="comment">// function to access thread-specific data</span></div><div class="line"><span class="keyword">thread_data_t</span>* get_tls(THREADID threadid)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">thread_data_t</span>* tdata = </div><div class="line">          <span class="keyword">static_cast</span>&lt;<span class="keyword">thread_data_t</span>*&gt;(PIN_GetThreadData(tls_key, threadid));</div><div class="line">    <span class="keyword">return</span> tdata;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This function is called before every block</span></div><div class="line"><span class="function">VOID PIN_FAST_ANALYSIS_CALL <span class="title">docount</span><span class="params">(UINT32 c, THREADID threadid)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">thread_data_t</span>* tdata = get_tls(threadid);</div><div class="line">    tdata-&gt;<span class="number">_</span>count += c;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">VOID <span class="title">ThreadStart</span><span class="params">(THREADID threadid, CONTEXT *ctxt, INT32 flags, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    PIN_GetLock(&amp;lock, threadid+<span class="number">1</span>);</div><div class="line">    numThreads++;</div><div class="line">    PIN_ReleaseLock(&amp;lock);</div><div class="line"></div><div class="line">    <span class="keyword">thread_data_t</span>* tdata = <span class="keyword">new</span> <span class="keyword">thread_data_t</span>;</div><div class="line"></div><div class="line">    PIN_SetThreadData(tls_key, tdata, threadid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Pin calls this function every time a new basic block is encountered.</span></div><div class="line"><span class="comment">// It inserts a call to docount.</span></div><div class="line"><span class="function">VOID <span class="title">Trace</span><span class="params">(TRACE trace, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Visit every basic block  in the trace</span></div><div class="line">    <span class="keyword">for</span> (BBL bbl = TRACE_BblHead(trace); BBL_Valid(bbl); bbl = BBL_Next(bbl))</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// Insert a call to docount for every bbl, passing the number of instructions.</span></div><div class="line">        </div><div class="line">        BBL_InsertCall(bbl, IPOINT_ANYWHERE, (AFUNPTR)docount, IARG_FAST_ANALYSIS_CALL,</div><div class="line">                       IARG_UINT32, BBL_NumIns(bbl), IARG_THREAD_ID, IARG_END);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This function is called when the application exits</span></div><div class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Write to a file since cout and cerr maybe closed by the application</span></div><div class="line">    OutFile &lt;&lt; <span class="string">"Total number of threads = "</span> &lt;&lt; numThreads &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (INT32 t=<span class="number">0</span>; t&lt;numThreads; t++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">thread_data_t</span>* tdata = get_tls(t);</div><div class="line">        OutFile &lt;&lt; <span class="string">"Count["</span> &lt;&lt; decstr(t) &lt;&lt; <span class="string">"]= "</span> &lt;&lt; tdata-&gt;<span class="number">_</span>count &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    OutFile.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Print Help Message                                                    */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool counts the number of dynamic instructions executed"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Main                                                                  */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Initialize pin</span></div><div class="line">    PIN_InitSymbols();</div><div class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</div><div class="line"></div><div class="line">    OutFile.open(KnobOutputFile.Value().c_str());</div><div class="line"></div><div class="line">    <span class="comment">// Initialize the lock</span></div><div class="line">    PIN_InitLock(&amp;lock);</div><div class="line"></div><div class="line">    <span class="comment">// Obtain  a key for TLS storage.</span></div><div class="line">    tls_key = PIN_CreateThreadDataKey(<span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Register ThreadStart to be called when a thread starts.</span></div><div class="line">    PIN_AddThreadStartFunction(ThreadStart, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Register Instruction to be called to instrument instructions.</span></div><div class="line">    TRACE_AddInstrumentFunction(Trace, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Register Fini to be called when the application exits.</span></div><div class="line">    PIN_AddFiniFunction(Fini, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Start the program, never returns</span></div><div class="line">    PIN_StartProgram();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Using-the-Fast-Buffering-APIs"><a href="#Using-the-Fast-Buffering-APIs" class="headerlink" title="Using the Fast Buffering APIs"></a>Using the Fast Buffering APIs</h1><p>Pin可以处理缓冲区数据。<br>如果分析函数近用于加载参数到缓冲区，则可使用缓冲API，减少性能开销。<br>PIN_DefineTraceBuffer()定义缓冲区，线程启动时分配缓冲区，线程退出时回收缓冲区。<br> INS_InsertFillBuffer()将请求数据直接写入给定缓冲区。<br> 当缓冲区满或线程退出时，PIN_DefineTraceBuffer()中的回调函数处理缓冲区。<br> 下例记录了所有访问内存指令的PC和这些指令的有效地址。<br> 注意：快速缓存APIs中不能使用 IARG_REG_REFERENCE, IARG_REG_CONST_REFERENCE and IARG_CONTEXT。</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">$ ../../../pin -t obj-ia32/buffer_linux.so -- obj-ia32/thread_lin</div><div class="line">$ tail buffer.out.*.*</div><div class="line"><span class="number">3263</span>df   <span class="number">330108</span></div><div class="line"><span class="number">3263</span>df   <span class="number">330108</span></div><div class="line"><span class="number">3263</span>f1   a92f43fc</div><div class="line"><span class="number">3263</span>f7   a92f4d7d</div><div class="line"><span class="number">326404</span>   a92f43fc</div><div class="line"><span class="number">32640</span>a   a92f4bf8</div><div class="line"><span class="number">32640</span>a   a92f4bf8</div><div class="line"><span class="number">32640</span>f   a92f4d94</div><div class="line"><span class="number">32641</span>b   a92f43fc</div><div class="line"><span class="number">326421</span>   a92f4bf8</div></pre></td></tr></table></figure>
<p>此例子适用于Linux平台，源码参见  source/tools/ManualExamples/buffer_linux.cpp<br>Windows用户参见 source/tools/ManualExamples/buffer_windows.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line"> * Sample buffering tool</div><div class="line"> * </div><div class="line"> * This tool collects an address trace of instructions that access memory</div><div class="line"> * by filling a buffer.  When the buffer overflows,the callback writes all</div><div class="line"> * of the collected records to a file.</div><div class="line"> *</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stddef.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"portability.H"</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Name of the output file</div><div class="line"> */</div><div class="line">KNOB&lt;<span class="built_in">string</span>&gt; KnobOutputFile(KNOB_MODE_WRITEONCE, <span class="string">"pintool"</span>, <span class="string">"o"</span>, <span class="string">"buffer.out"</span>, <span class="string">"output file"</span>);</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * The ID of the buffer</div><div class="line"> */</div><div class="line">BUFFER_ID bufId;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Thread specific data</div><div class="line"> */</div><div class="line">TLS_KEY mlog_key;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Number of OS pages for the buffer</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_BUF_PAGES 1024</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Record of memory references.  Rather than having two separate</div><div class="line"> * buffers for reads and writes, we just use one struct that includes a</div><div class="line"> * flag for type.</div><div class="line"> */</div><div class="line"><span class="keyword">struct</span> MEMREF</div><div class="line">&#123;</div><div class="line">    ADDRINT     pc;</div><div class="line">    ADDRINT     ea;</div><div class="line">    UINT32      size;</div><div class="line">    BOOL        read;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * MLOG - thread specific data that is not handled by the buffering API.</div><div class="line"> */</div><div class="line"><span class="keyword">class</span> MLOG</div><div class="line">&#123;</div><div class="line">  <span class="keyword">public</span>:</div><div class="line">    MLOG(THREADID tid);</div><div class="line">    ~MLOG();</div><div class="line"></div><div class="line">    <span class="function">VOID <span class="title">DumpBufferToFile</span><span class="params">( <span class="keyword">struct</span> MEMREF * reference, UINT64 numElements, THREADID tid )</span></span>;</div><div class="line"></div><div class="line">  <span class="keyword">private</span>:</div><div class="line">    ofstream <span class="number">_</span>ofile;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">MLOG::MLOG(THREADID tid)</div><div class="line">&#123;</div><div class="line">    <span class="built_in">string</span> filename = KnobOutputFile.Value() + <span class="string">"."</span> + decstr(getpid_portable()) + <span class="string">"."</span> + decstr(tid);</div><div class="line">    </div><div class="line">    <span class="number">_</span>ofile.open(filename.c_str());</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ( ! <span class="number">_</span>ofile )</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">cerr</span> &lt;&lt; <span class="string">"Error: could not open output file."</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="number">_</span>ofile &lt;&lt; hex;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">MLOG::~MLOG()</div><div class="line">&#123;</div><div class="line">    <span class="number">_</span>ofile.close();</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">VOID MLOG::DumpBufferToFile( <span class="keyword">struct</span> MEMREF * reference, UINT64 numElements, THREADID tid )</div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span>(UINT64 i=<span class="number">0</span>; i&lt;numElements; i++, reference++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (reference-&gt;ea != <span class="number">0</span>)</div><div class="line">            <span class="number">_</span>ofile &lt;&lt; reference-&gt;pc &lt;&lt; <span class="string">"   "</span> &lt;&lt; reference-&gt;ea &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**************************************************************************</span></div><div class="line"> *</div><div class="line"> *  Instrumentation routines</div><div class="line"> *</div><div class="line"> **************************************************************************/</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Insert code to write data to a thread-specific buffer for instructions</div><div class="line"> * that access memory.</div><div class="line"> */</div><div class="line"><span class="function">VOID <span class="title">Trace</span><span class="params">(TRACE trace, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">for</span>(BBL bbl = TRACE_BblHead(trace); BBL_Valid(bbl); bbl=BBL_Next(bbl))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span>(INS ins = BBL_InsHead(bbl); INS_Valid(ins); ins=INS_Next(ins))</div><div class="line">        &#123;</div><div class="line">            UINT32 memoryOperands = INS_MemoryOperandCount(ins);</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (UINT32 memOp = <span class="number">0</span>; memOp &lt; memoryOperands; memOp++)</div><div class="line">            &#123;</div><div class="line">                UINT32 refSize = INS_MemoryOperandSize(ins, memOp);</div><div class="line"></div><div class="line">                <span class="comment">// Note that if the operand is both read and written we log it once</span></div><div class="line">                <span class="comment">// for each.</span></div><div class="line">                <span class="keyword">if</span> (INS_MemoryOperandIsRead(ins, memOp))</div><div class="line">                &#123;</div><div class="line">                    INS_InsertFillBuffer(ins, IPOINT_BEFORE, bufId,</div><div class="line">                                         IARG_INST_PTR, offsetof(<span class="keyword">struct</span> MEMREF, pc),</div><div class="line">                                         IARG_MEMORYOP_EA, memOp, offsetof(<span class="keyword">struct</span> MEMREF, ea),</div><div class="line">                                         IARG_UINT32, refSize, offsetof(<span class="keyword">struct</span> MEMREF, size), </div><div class="line">                                         IARG_BOOL, TRUE, offsetof(<span class="keyword">struct</span> MEMREF, read),</div><div class="line">                                         IARG_END);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (INS_MemoryOperandIsWritten(ins, memOp))</div><div class="line">                &#123;</div><div class="line">                    INS_InsertFillBuffer(ins, IPOINT_BEFORE, bufId,</div><div class="line">                                         IARG_INST_PTR, offsetof(<span class="keyword">struct</span> MEMREF, pc),</div><div class="line">                                         IARG_MEMORYOP_EA, memOp, offsetof(<span class="keyword">struct</span> MEMREF, ea),</div><div class="line">                                         IARG_UINT32, refSize, offsetof(<span class="keyword">struct</span> MEMREF, size), </div><div class="line">                                         IARG_BOOL, FALSE, offsetof(<span class="keyword">struct</span> MEMREF, read),</div><div class="line">                                         IARG_END);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/**************************************************************************</span></div><div class="line"> *</div><div class="line"> *  Callback Routines</div><div class="line"> *</div><div class="line"> **************************************************************************/</div><div class="line"></div><div class="line"><span class="function">VOID * <span class="title">BufferFull</span><span class="params">(BUFFER_ID id, THREADID tid, <span class="keyword">const</span> CONTEXT *ctxt, VOID *buf,</span></span></div><div class="line">                  UINT64 numElements, VOID *v)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> MEMREF * reference=(<span class="keyword">struct</span> MEMREF*)buf;</div><div class="line"></div><div class="line">    MLOG * mlog = <span class="keyword">static_cast</span>&lt;MLOG*&gt;( PIN_GetThreadData( mlog_key, tid ) );</div><div class="line"></div><div class="line">    mlog-&gt;DumpBufferToFile( reference, numElements, tid );</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> buf;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"> * Note that opening a file in a callback is only supported on Linux systems.</div><div class="line"> * See buffer-win.cpp for how to work around this issue on Windows.</div><div class="line"> */</div><div class="line"><span class="function">VOID <span class="title">ThreadStart</span><span class="params">(THREADID tid, CONTEXT *ctxt, INT32 flags, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// There is a new MLOG for every thread.  Opens the output file.</span></div><div class="line">    MLOG * mlog = <span class="keyword">new</span> MLOG(tid);</div><div class="line"></div><div class="line">    <span class="comment">// A thread will need to look up its MLOG, so save pointer in TLS</span></div><div class="line">    PIN_SetThreadData(mlog_key, mlog, tid);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function">VOID <span class="title">ThreadFini</span><span class="params">(THREADID tid, <span class="keyword">const</span> CONTEXT *ctxt, INT32 code, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    MLOG * mlog = <span class="keyword">static_cast</span>&lt;MLOG*&gt;(PIN_GetThreadData(mlog_key, tid));</div><div class="line"></div><div class="line">    <span class="keyword">delete</span> mlog;</div><div class="line"></div><div class="line">    PIN_SetThreadData(mlog_key, <span class="number">0</span>, tid);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Print Help Message                                                    */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool demonstrates the basic use of the buffering API."</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Main                                                                  */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Initialize PIN library. Print help message if -h(elp) is specified</span></div><div class="line">    <span class="comment">// in the command line or the command line is invalid</span></div><div class="line">    <span class="keyword">if</span>( PIN_Init(argc,argv) )</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> Usage();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Initialize the memory reference buffer;</span></div><div class="line">    <span class="comment">// set up the callback to process the buffer.</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    bufId = PIN_DefineTraceBuffer(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> MEMREF), NUM_BUF_PAGES,</div><div class="line">                                  BufferFull, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span>(bufId == BUFFER_ID_INVALID)</div><div class="line">    &#123;</div><div class="line">        <span class="built_in">cerr</span> &lt;&lt; <span class="string">"Error: could not allocate initial buffer"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Initialize thread-specific data not handled by buffering api.</span></div><div class="line">    mlog_key = PIN_CreateThreadDataKey(<span class="number">0</span>);</div><div class="line">   </div><div class="line">    <span class="comment">// add an instrumentation function</span></div><div class="line">    TRACE_AddInstrumentFunction(Trace, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// add callbacks</span></div><div class="line">    PIN_AddThreadStartFunction(ThreadStart, <span class="number">0</span>);</div><div class="line">    PIN_AddThreadFiniFunction(ThreadFini, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Start the program, never returns</span></div><div class="line">    PIN_StartProgram();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Finding-the-Static-Properties-of-an-Image-查看镜像的静态属性"><a href="#Finding-the-Static-Properties-of-an-Image-查看镜像的静态属性" class="headerlink" title="Finding the Static Properties of an Image 查看镜像的静态属性"></a>Finding the Static Properties of an Image 查看镜像的静态属性</h1><p>在不插装的情况下，可以使用Pin检查二进制文件，用于帮助程序员查看镜像的静态属性。<br>下例展示了，未插装时，镜像中的指令数。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// This tool prints a trace of image load and unload events</span></div><div class="line"><span class="comment">//</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// Pin calls this function every time a new img is loaded</span></div><div class="line"><span class="comment">// It can instrument the image, but this example merely</span></div><div class="line"><span class="comment">// counts the number of static instructions in the image</span></div><div class="line"></div><div class="line"><span class="function">VOID <span class="title">ImageLoad</span><span class="params">(IMG img, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    UINT32 count = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (SEC sec = IMG_SecHead(img); SEC_Valid(sec); sec = SEC_Next(sec))</div><div class="line">    &#123; </div><div class="line">        <span class="keyword">for</span> (RTN rtn = SEC_RtnHead(sec); RTN_Valid(rtn); rtn = RTN_Next(rtn))</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// Prepare for processing of RTN, an  RTN is not broken up into BBLs,</span></div><div class="line">            <span class="comment">// it is merely a sequence of INSs </span></div><div class="line">            RTN_Open(rtn);</div><div class="line">            </div><div class="line">            <span class="keyword">for</span> (INS ins = RTN_InsHead(rtn); INS_Valid(ins); ins = INS_Next(ins))</div><div class="line">            &#123;</div><div class="line">                count++;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// to preserve space, release data associated with RTN after we have processed it</span></div><div class="line">            RTN_Close(rtn);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Image %s has  %d instructions\n"</span>, IMG_Name(img).c_str(), count);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Print Help Message                                                    */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool prints a log of image load and unload events"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">" along with static instruction counts for each image."</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Main                                                                  */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// prepare for image instrumentation mode</span></div><div class="line">    PIN_InitSymbols();</div><div class="line"></div><div class="line">    <span class="comment">// Initialize pin</span></div><div class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</div><div class="line"></div><div class="line">    <span class="comment">// Register ImageLoad to be called when an image is loaded</span></div><div class="line">    IMG_AddInstrumentFunction(ImageLoad, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Start the program, never returns</span></div><div class="line">    PIN_StartProgram();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Detaching-Pin-from-the-Application"><a href="#Detaching-Pin-from-the-Application" class="headerlink" title="Detaching Pin from the Application"></a>Detaching Pin from the Application</h1><p>调用PIN_Detach放弃Pin对程序的控制权，程序以原有速度执行未插装的原始代码。</p>
<p>源码参见 source/tools/ManualExamples/detach.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">// This tool shows how to detach Pin from an </span></div><div class="line"><span class="comment">// application that is under Pin's control.</span></div><div class="line"></div><div class="line">UINT64 icount = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N 10000</span></div><div class="line"><span class="function">VOID <span class="title">docount</span><span class="params">()</span> </span></div><div class="line">&#123;</div><div class="line">    icount++;</div><div class="line"></div><div class="line">    <span class="comment">// Release control of application if 10000 </span></div><div class="line">    <span class="comment">// instructions have been executed</span></div><div class="line">    <span class="keyword">if</span> ((icount % N) == <span class="number">0</span>) </div><div class="line">    &#123;</div><div class="line">        PIN_Detach();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"> </div><div class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)docount, IARG_END);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">VOID <span class="title">ByeWorld</span><span class="params">(VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">std</span>::<span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; <span class="string">"Detached at icount = "</span> &lt;&lt; N &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Print Help Message                                                    */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool demonstrates how to detach Pin from an "</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"application that is under Pin's control"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="built_in">endl</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Main                                                                  */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (PIN_Init(argc, argv)) <span class="keyword">return</span> Usage();</div><div class="line"></div><div class="line">    <span class="comment">// Callback function to invoke for every </span></div><div class="line">    <span class="comment">// execution of an instruction</span></div><div class="line">    INS_AddInstrumentFunction(Instruction, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// Callback functions to invoke before</span></div><div class="line">    <span class="comment">// Pin releases control of the application</span></div><div class="line">    PIN_AddDetachFunction(ByeWorld, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// Never returns</span></div><div class="line">    PIN_StartProgram();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="Instrumenting-Child-Processes"><a href="#Instrumenting-Child-Processes" class="headerlink" title="Instrumenting Child Processes"></a>Instrumenting Child Processes</h1><p>PIN_AddFollowChildProcessFunction()允许程序员在execv进程开始前定义想要执行的函数。<br>在命令行中使用  -follow_execv 选项插装子进程，如下：<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ ..<span class="regexp">/../</span>..<span class="regexp">/pin -follow_execv -t obj-intel64/</span>follow_child_tool.so -- obj-intel64<span class="regexp">/follow_child_app1 obj-intel64/</span>follow_child_app2</div></pre></td></tr></table></figure></p>
<p>源码参见 source/tools/ManualExamples/follow_child_tool.cpp ，使用下列命令build test文件：<br><figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="variable">$ </span>make follow_child_tool.test</div></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"><span class="comment">/* Command line Switches */</span></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function">BOOL <span class="title">FollowChild</span><span class="params">(CHILD_PROCESS childProcess, VOID * userData)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>, <span class="string">"before child:%u\n"</span>, getpid());</div><div class="line">    <span class="keyword">return</span> TRUE;</div><div class="line">&#125;        </div><div class="line"></div><div class="line"><span class="comment">/* ===================================================================== */</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(INT32 argc, CHAR **argv)</span></span></div><div class="line">&#123;</div><div class="line">    PIN_Init(argc, argv);</div><div class="line"></div><div class="line">    PIN_AddFollowChildProcessFunction(FollowChild, <span class="number">0</span>);</div><div class="line"></div><div class="line">    PIN_StartProgram();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="Managed-platforms-support"><a href="#Managed-platforms-support" class="headerlink" title="Managed platforms support"></a>Managed platforms support</h1><p>Pintools中的 RTN_IsDynamic() 校验动态生成的代码。<br>下例展示了 RTN_IsDynamic() 的用法，通过插装程序，计算发现并执行的指令总数，指令分为三类：原生指令，动态指令和 instructions without any known routine。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">$ <span class="keyword">set</span> CL_CONFIG_USE_VTUNE=<span class="literal">True</span></div><div class="line">$ <span class="keyword">set</span> INTEL_JIT_PROFILER32=ia32\<span class="keyword">bin</span>\pinjitprofiling.dll</div><div class="line">$ ia32\<span class="keyword">bin</span>\pin.exe -t <span class="keyword">source</span>\tools\JitProfilingApiTests\obj-ia32\DynamicInsCount.dll -support_jit_api -o DynamicInsCount.out <span class="comment">-- ..\OpenCL\Win32\Debug\BitonicSort.exe</span></div><div class="line"><span class="keyword">No</span> command line arguments specified, <span class="keyword">using</span> <span class="keyword">default</span> values.</div><div class="line">Initializing OpenCL runtime...</div><div class="line">Trying <span class="keyword">to</span> run <span class="keyword">on</span> a CPU</div><div class="line">OpenCL <span class="keyword">data</span> alignment <span class="keyword">is</span> <span class="number">128</span> bytes.</div><div class="line">Reading <span class="keyword">file</span> <span class="string">'BitonicSort.cl'</span> (<span class="keyword">size</span> <span class="number">3435</span> <span class="keyword">bytes</span>)</div><div class="line"><span class="keyword">Sort</span> <span class="keyword">order</span> <span class="keyword">is</span> ascending</div><div class="line"><span class="keyword">Input</span> <span class="keyword">size</span> <span class="keyword">is</span> <span class="number">1048576</span> items</div><div class="line">Executing OpenCL kernel...</div><div class="line">Executing reference...</div><div class="line">Performing verification...</div><div class="line">Verification succeeded.</div><div class="line">NDRange perf. counter <span class="keyword">time</span> <span class="number">12994.272962</span> ms.</div><div class="line">Releasing resources...</div><div class="line">$ <span class="keyword">type</span> JitInsCount.out</div><div class="line">===============================================</div><div class="line"><span class="built_in">Number</span> <span class="keyword">of</span> executed <span class="keyword">native</span> instructions: <span class="number">7631596649</span></div><div class="line"><span class="built_in">Number</span> <span class="keyword">of</span> executed jitted instructions: <span class="number">438983207</span></div><div class="line"><span class="built_in">Number</span> <span class="keyword">of</span> executed instructions <span class="keyword">without</span> <span class="keyword">any</span> known routine: <span class="number">12246</span></div><div class="line">===============================================</div><div class="line"><span class="built_in">Number</span> <span class="keyword">of</span> discovered <span class="keyword">native</span> instructions: <span class="number">870531</span></div><div class="line"><span class="built_in">Number</span> <span class="keyword">of</span> discovered jitted instructions: <span class="number">223</span></div><div class="line"><span class="built_in">Number</span> <span class="keyword">of</span> discovered instructions <span class="keyword">without</span> <span class="keyword">any</span> known routine: <span class="number">36</span></div><div class="line">===============================================</div></pre></td></tr></table></figure>
<p>源码参见  source.cpp<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"pin.H"</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span></span></div><div class="line"></div><div class="line"><span class="comment">// ==================================================================</span></div><div class="line"><span class="comment">// Global variables</span></div><div class="line"><span class="comment">// ==================================================================</span></div><div class="line"></div><div class="line">UINT64 insNativeDiscoveredCount = <span class="number">0</span>;  <span class="comment">//number of discovered native instructions</span></div><div class="line">UINT64 insDynamicDiscoveredCount = <span class="number">0</span>; <span class="comment">//number of discovered dynamic instructions</span></div><div class="line">UINT64 insNoRtnDiscoveredCount = <span class="number">0</span>;   <span class="comment">//number of discovered instructions without any known routine</span></div><div class="line"></div><div class="line">UINT64 insNativeExecutedCount = <span class="number">0</span>;  <span class="comment">//number of executed native instructions</span></div><div class="line">UINT64 insDynamicExecutedCount = <span class="number">0</span>; <span class="comment">//number of executed dynamic instructions</span></div><div class="line">UINT64 insNoRtnExecutedCount = <span class="number">0</span>;   <span class="comment">//number of executed instructions without any known routine</span></div><div class="line"></div><div class="line"><span class="built_in">std</span>::ostream * out = &amp;<span class="built_in">cerr</span>;</div><div class="line"></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"><span class="comment">// Command line switches</span></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"></div><div class="line">KNOB&lt;<span class="built_in">string</span>&gt; KnobOutputFile(KNOB_MODE_WRITEONCE,  <span class="string">"pintool"</span>, <span class="string">"o"</span>, <span class="string">""</span>, <span class="string">"specify file name for output"</span>);</div><div class="line"></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"><span class="comment">// Utilities</span></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"></div><div class="line"><span class="comment">// Print out help message.</span></div><div class="line"><span class="function">INT32 <span class="title">Usage</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; <span class="string">"This tool prints out the number of native and dynamic instructions"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="built_in">cerr</span> &lt;&lt; KNOB_BASE::StringKnobSummary() &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"><span class="comment">// Analysis routines</span></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"></div><div class="line"><span class="comment">// This function is called before every native instruction is executed</span></div><div class="line"><span class="function">VOID <span class="title">InsNativeCount</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    ++insNativeExecutedCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This function is called before every dynamic instruction is executed</span></div><div class="line"><span class="function">VOID <span class="title">InsDynamicCount</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    ++insDynamicExecutedCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// This function is called before every instruction without any known routine is executed</span></div><div class="line"><span class="function">VOID <span class="title">InsNoRtnCount</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    ++insNoRtnExecutedCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"><span class="comment">// Instrumentation callbacks</span></div><div class="line"><span class="comment">// =====================================================================</span></div><div class="line"></div><div class="line"><span class="comment">// Pin calls this function every time a new instruction is encountered</span></div><div class="line"><span class="function">VOID <span class="title">Instruction</span><span class="params">(INS ins, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    RTN rtn = INS_Rtn(ins);</div><div class="line">    <span class="keyword">if</span> (!RTN_Valid(rtn))</div><div class="line">    &#123;</div><div class="line">        ++insNoRtnDiscoveredCount;</div><div class="line">        INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)InsNoRtnCount, IARG_END);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (RTN_IsDynamic(rtn))</div><div class="line">    &#123;</div><div class="line">        ++insDynamicDiscoveredCount;</div><div class="line">        INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)InsDynamicCount, IARG_END);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        ++insNativeDiscoveredCount;</div><div class="line">        INS_InsertCall(ins, IPOINT_BEFORE, (AFUNPTR)InsNativeCount, IARG_END);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Print out analysis results.</span></div><div class="line"><span class="comment">// This function is called when the application exits.</span></div><div class="line"><span class="comment">// @param[in]   code            exit code of the application</span></div><div class="line"><span class="comment">// @param[in]   v               value specified by the tool in the</span></div><div class="line"><span class="comment">//                              PIN_AddFiniFunction function call</span></div><div class="line"><span class="function">VOID <span class="title">Fini</span><span class="params">(INT32 code, VOID *v)</span></span></div><div class="line">&#123;</div><div class="line">    *out &lt;&lt;  <span class="string">"==============================================="</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"Number of executed native instructions: "</span> &lt;&lt; insNativeExecutedCount &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"Number of executed dynamic instructions: "</span> &lt;&lt; insDynamicExecutedCount &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"Number of executed instructions without any known routine: "</span> &lt;&lt; insNoRtnExecutedCount &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"==============================================="</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"Number of discovered native instructions: "</span> &lt;&lt; insNativeDiscoveredCount &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"Number of discovered dynamic instructions: "</span> &lt;&lt; insDynamicDiscoveredCount &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"Number of discovered instructions without any known routine: "</span> &lt;&lt; insNoRtnDiscoveredCount &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">    *out &lt;&lt;  <span class="string">"==============================================="</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line"></div><div class="line">    <span class="built_in">string</span> fileName = KnobOutputFile.Value();</div><div class="line">    <span class="keyword">if</span> (!fileName.empty())</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> out;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// The main procedure of the tool.</span></div><div class="line"><span class="comment">// This function is called when the application image is loaded but not yet started.</span></div><div class="line"><span class="comment">// @param[in]   argc            total number of elements in the argv array</span></div><div class="line"><span class="comment">// @param[in]   argv            array of command line arguments,</span></div><div class="line"><span class="comment">//                              including pin -t &lt;toolname&gt; -- ...</span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// Initialize symbol processing</span></div><div class="line">    PIN_InitSymbols();</div><div class="line"></div><div class="line">    <span class="comment">// Initialize PIN library. Print help message if -h(elp) is specified</span></div><div class="line">    <span class="comment">// in the command line or the command line is invalid</span></div><div class="line">    <span class="keyword">if</span>(PIN_Init(argc,argv))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">return</span> Usage();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="built_in">string</span> fileName = KnobOutputFile.Value();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!fileName.empty())</div><div class="line">    &#123;</div><div class="line">        out = <span class="keyword">new</span> <span class="built_in">std</span>::ofstream(fileName.c_str());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Register Instruction to be called to instrument instructions</span></div><div class="line">    INS_AddInstrumentFunction(Instruction, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Register function to be called when the application exits</span></div><div class="line">    PIN_AddFiniFunction(Fini, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Start the program, never returns</span></div><div class="line">    PIN_StartProgram();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1><p><a href="https://software.intel.com/sites/landingpage/pintool/docs/67254/Pin/html/" target="_blank" rel="external">Pin 用户手册</a></p>

    
  </div>
</article>

</div>


  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">走过的，路过的，请支持一下我 n(*≧▽≦*)n</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/qr-wechat.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>




  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'huirong';
    
    var disqus_url = 'http://huirong.github.io/2016/01/10/Intel-Pin-Example4/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//huirong.disqus.com/count.js" async></script>



    
  <section class="duoshuo-comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="http://huirong.github.io/2016/01/10/Intel-Pin-Example4/index.html" data-title="Intel Pin 2 ：示例（再续）" data-url="http://huirong.github.io/2016/01/10/Intel-Pin-Example4/index.html"></div>
    <!-- 多说评论框 end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"star"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
